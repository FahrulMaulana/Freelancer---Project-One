<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAW Directory - Local Business Listings</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUEFXIERpcmVjdG9yeSIsInNob3J0X25hbWUiOiJQQVciLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiJ9">
    
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .form-error {
            color: var(--danger);
            font-size: 14px;
            padding: 10px;
            background-color: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            display: none;
        }

        .app-container {
            max-width: 430px;
            margin: 0 auto;
            background: var(--bg-primary);
            min-height: 100vh;
            position: relative;
            box-shadow: var(--shadow-lg);
            padding-bottom: 90px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 20px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            border-radius: 0 0 25px 25px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .app-title {
            font-size: 28px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .search-input:focus {
            background: white;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 18px;
        }

        .search-clear {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bg-secondary);
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .search-clear:hover {
            background: var(--border);
        }

        /* Search Results */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: 200;
            display: none;
            margin-top: 10px;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg-secondary);
        }

        .search-result-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 16px;
        }

        .search-result-info h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .search-result-meta {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .search-highlight {
            background: rgba(99, 102, 241, 0.2);
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 600;
        }

        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Page */
        .welcome-section {
            padding: 30px 20px 20px;
            background: var(--bg-secondary);
        }

        .welcome-text {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome-text h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .welcome-text p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
        }

        .category-card {
            background: white;
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: translateY(-4px);
            transition: all 0.3s ease;
        }

        .category-card:hover::before {
            transform: translateY(0);
        }

        .category-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .category-icon {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }

        .category-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .category-count {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .subcategories {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Listings Page */
        .listings-header {
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .back-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .listings-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .listings-subtitle {
            color: var(--text-secondary);
        }

        .filter-section {
            padding: 20px;
            background: var(--bg-secondary);
        }

        .filter-chips {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            margin-bottom: 15px;
        }

        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            background: white;
            border: 2px solid var(--border);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        .filter-chip.active,
        .filter-chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .subcategory-filters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .subcategory-filters::-webkit-scrollbar {
            display: none;
        }

        .subcategory-chip {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .subcategory-chip.active,
        .subcategory-chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .businesses-list {
            padding: 0 20px 20px;
        }

        .business-card {
            background: white;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .business-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .business-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .business-content {
            padding: 20px;
        }

        .business-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .business-info h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .business-category {
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            background: rgba(99, 102, 241, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
            display: inline-block;
        }

        .business-subcategory {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            margin-top: 4px;
        }

        .business-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .rating-stars {
            color: #fbbf24;
        }

        .business-details {
            margin-top: 15px;
        }

        .business-detail {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .business-detail:last-child {
            margin-bottom: 0;
        }

        .business-detail i {
            width: 16px;
            margin-right: 12px;
            color: var(--primary);
        }

        .business-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 15px 20px;
            z-index: 200;
            border-radius: 25px 25px 0 0;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .nav-item:hover {
            transform: translateY(-3px);
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }

        .nav-item.active i {
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 25px 25px 0 0;
            padding: 30px 20px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: -10px;
            right: 0;
            background: var(--bg-secondary);
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--border);
            transform: rotate(90deg);
        }

        .modal-image {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            margin: 0 auto 15px;
            object-fit: cover;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .modal-category {
            color: var(--primary);
            font-weight: 600;
            background: rgba(99, 102, 241, 0.1);
            padding: 6px 16px;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;  /* Ubah dari 1fr 1fr menjadi 1fr 1fr 1fr */
            gap: 10px;
            margin: 25px 0;
        }   

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .favorite-btn i {
            margin-right: 5px;
        }

        .heart-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.8);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .heart-icon:hover {
            transform: scale(1.1);
            background: white;
        }

        .heart-icon i {
            font-size: 18px;
            color: #aaa;
        }

        .heart-icon.active i {
            color: #ef4444;
        }

        .heart-icon.active {
            background: white;
        }

        .business-card {
            position: relative;
        }

        .floating-add {
            position: fixed;
            bottom: 110px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            z-index: 150;
        }

        .floating-add i {
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .floating-add:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.6);
        }

        /* Responsive */
        @media (min-width: 768px) {
            .app-container {
                max-width: 500px;
            }
            
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .profile-dropdown {
        position: absolute;
        top: 60px;
        right: 20px;
        width: 150px;
        background: var(--bg-primary);
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border: #576c8d 1px solid;
        z-index: 300;
        display: none;
        overflow: hidden;
        transform-origin: top right;
        animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .dropdown-header {
            padding: 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .dropdown-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .dropdown-content {
            padding: 0px;
        }

        /* Filter Controls Styling */
        .filter-controls {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .filter-controls:hover {
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-row label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 120px;
        }

        .filter-row select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            min-width: 200px;
            background-color: white;
            font-size: 14px;
            flex: 0 0 auto;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="6" viewBox="0 0 12 6"><path fill="%23667eea" d="M0 0l6 6 6-6z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 35px;
        }

        .filter-row select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        .search-box {
            flex: 1;
            position: relative;
            min-width: 200px;
            max-width: 500px;
            margin-left: auto;
        }

        .search-box input {
            width: 100%;
            padding: 10px 42px 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: white;
        }

        .search-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        .search-btn {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 42px;
            background: none;
            border: none;
            padding: 0;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        /* Pagination Controls Styling */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 25px;
            padding: 15px;
            background-color: #f8fafc;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        #subcategoryPageInfo {
            margin: 0 20px;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 150px;
            text-align: center;
            font-size: 14px;
        }

        #subcategoryPrevPageBtn,
        #subcategoryNextPageBtn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: white;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        #subcategoryPrevPageBtn:not(:disabled):hover,
        #subcategoryNextPageBtn:not(:disabled):hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        #subcategoryPrevPageBtn:disabled,
        #subcategoryNextPageBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Subcategory Form Styling */
        #addSubcategoryFormContainer,
        #editSubcategoryFormContainer {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 20px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #addSubcategoryFormContainer .admin-section-header,
        #editSubcategoryFormContainer .admin-section-header {
            margin-bottom: 25px;
        }

        #addSubcategoryFormContainer h2,
        #editSubcategoryFormContainer h2 {
            font-size: 24px;
            margin: 0;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        #editSubcategoryFormContainer h2 {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
        }

        /* Highlight for form fields */
        #addSubcategoryForm .form-row input:focus,
        #addSubcategoryForm .form-row select:focus,
        #addSubcategoryForm .form-row textarea:focus,
        #editSubcategoryForm .form-row input:focus,
        #editSubcategoryForm .form-row select:focus,
        #editSubcategoryForm .form-row textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-row label {
                margin-bottom: 5px;
            }
            
            .filter-row select,
            .search-box {
                width: 100%;
            }
            
            .search-box {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            #subcategoryPageInfo {
                order: 3;
                width: 100%;
                margin: 10px 0 0;
            }
        }

        /* Table styling refinements */
        .admin-table-container {
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
        }

        .admin-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-weight: 600;
            padding: 15px;
            border: none;
        }

        .admin-table td {
            padding: 12px 15px;
            vertical-align: middle;
        }

        .admin-table tr:nth-child(even) {
            background-color: rgba(99, 102, 241, 0.05);
        }

        .admin-table tr:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .admin-table th {
            display: table-cell !important;
            visibility: visible !important;
            color: white !important;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%) !important;
            padding: 15px !important;
            font-weight: 600 !important;
            text-align: left !important;
            border-bottom: 1px solid var(--border) !important;
        }

        .admin-table thead {
            display: table-header-group !important;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="app-title">
                    üêæ PAW Directory
                </div>
                <button class="profile-btn" id="profileBtn" onclick="toggleProfileDropdown()">
                    <i class="fas fa-user"></i>
                </button>
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="dropdown-content" id="dropdownContent">
                        <!-- Content will be populated dynamically by updateDropdownContent() -->
                    </div>
                </div>
            </div>
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search businesses, categories..." id="searchInput">
                <i class="fas fa-times search-clear" id="searchClear"></i>
                <div class="search-results" id="searchResults"></div>
            </div>
        </header>

        <!-- Home Page -->
        <div class="page active" id="homePage">
            <div class="welcome-section" data-aos="fade-up">
                <div class="welcome-text">
                    <h2>Discover Local Businesses</h2>
                    <p>Find the best services near you</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card" data-aos="fade-up" data-aos-delay="100">
                        <div class="stat-number">250+</div>
                        <div class="stat-label">Businesses</div>
                    </div>
                    <div class="stat-card" data-aos="fade-up" data-aos-delay="200">
                        <div class="stat-number">8</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-card" data-aos="fade-up" data-aos-delay="300">
                        <div class="stat-number">4.8</div>
                        <div class="stat-label">Avg Rating</div>
                    </div>
                </div>
            </div>

            <div class="categories-grid" id="categoriesGrid">
                <!-- Categories will be populated here -->
            </div>
        </div>

        <!-- Listings Page -->
        <div class="page" id="listingsPage">
            <div class="listings-header">
                <button class="back-btn" onclick="showPage('home')">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </button>
                <h2 class="listings-title" id="listingsTitle">All Businesses</h2>
                <p class="listings-subtitle" id="listingsSubtitle">Discover amazing local services</p>
            </div>

            <div class="filter-section">
                <div class="filter-chips" id="filterChips">
                    <!-- Filter chips will be populated here -->
                </div>
                <div class="subcategory-filters" id="subcategoryFilters">
                    <!-- Subcategory filters will be populated here -->
                </div>
            </div>

            <div class="businesses-list" id="businessesList">
                <!-- Businesses will be populated here -->
            </div>
        </div>

        <!-- Favorites Page -->
        <div class="page" id="favoritesPage">
            <div class="listings-header">
                <h2 class="listings-title">Your Favorites</h2>
                <p class="listings-subtitle">Businesses you love</p>
            </div>
            <!-- <div class="empty-state">
                <div class="empty-icon">üíù</div>
                <div class="empty-title">No favorites yet</div>
                <p>Start adding businesses to your favorites!</p>
            </div> -->
            <div id="favoritesContent"></div>
        </div>

        <!-- Profile Page -->
        <div class="page" id="profilePage">
            <div class="listings-header">
                <h2 class="listings-title">Your Profile</h2>
                <p class="listings-subtitle">Manage your account</p>
            </div>
            <div class="empty-state">
                <div class="empty-icon">üë§</div>
                <div class="empty-title">Profile Settings</div>
                <p>Coming soon!</p>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-items">
                <div class="nav-item active" onclick="showPage('home')">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </div>
                <div class="nav-item" onclick="showPage('listings', 'all')">
                    <i class="fas fa-list"></i>
                    <span>Browse</span>
                </div>
                <div class="nav-item" onclick="showPage('favorites')">
                    <i class="fas fa-heart"></i>
                    <span>Favorites</span>
                </div>
                <div class="nav-item" onclick="showPage('profile')">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </div>
            </div>
        </nav>

        <!-- Floating Add Button -->
        <button class="floating-add" onclick="alert('Add new business feature coming soon!')">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Modal -->
    <div class="modal" id="businessModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <img class="modal-image" id="modalImage" alt="Business">
                <h2 class="modal-title" id="modalTitle"></h2>
                <div class="modal-category" id="modalCategory"></div>
            </div>
            <div id="modalDetails"></div>
            <div class="modal-actions">
                <button class="action-btn btn-primary" id="callBtn">
                    <i class="fas fa-phone"></i> Call
                </button>
                <button class="action-btn btn-secondary" id="directionBtn">
                    <i class="fas fa-map-marker-alt"></i> Directions
                </button>
            </div>
        </div>
    </div>

    <!-- Tambahkan kode berikut sebelum tag penutup </div> terakhir di body -->

<!-- Admin Modal -->
<div class="modal" id="adminModal">
    <div class="modal-content admin-modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Admin Dashboard</h2>
            <button class="modal-close" onclick="closeAdminModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="admin-tabs">
            <div class="admin-tab active" data-tab="add-listing">Add Listing</div>
            <div class="admin-tab" data-tab="manage-listings">Manage Listings</div>
            <div class="admin-tab" data-tab="categories">Categories</div>
            <div class="admin-tab" data-tab="manage-subcategories">Subcategories</div>
        </div>
        
        <div class="admin-content">
            <!-- Add Listing Tab -->
            <div class="admin-tab-content active" id="add-listing-content">
                <form id="addListingForm" class="admin-form">
                    <div class="form-row">
                        <label for="businessName">Business Name *</label>
                        <input type="text" id="businessName" name="name" required placeholder="Enter business name">
                    </div>
                    
                    <div class="form-row">
                        <label for="businessCategory">Category *</label>
                        <select id="businessCategory" name="categoryId" required onchange="loadSubcategories()">
                            <option value="">Select a category</option>
                            <!-- Categories will be populated here -->
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <label for="businessSubcategory">Subcategory</label>
                        <select id="businessSubcategory" name="subcategoryId">
                            <option value="">Select a subcategory</option>
                            <!-- Subcategories will be populated here -->
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <label for="businessDescription">Description *</label>
                        <textarea id="businessDescription" name="description" required placeholder="Describe the business"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <label for="businessPhone">Phone Number *</label>
                        <input type="tel" id="businessPhone" name="phone" required placeholder="Enter phone number">
                    </div>
                    
                    <div class="form-row">
                        <label for="businessAddress">Address *</label>
                        <input type="text" id="businessAddress" name="address" required placeholder="Enter business address">
                    </div>
                    
                    <div class="form-row two-col">
                        <div>
                            <label for="businessLatitude">Latitude</label>
                            <input type="number" id="businessLatitude" name="latitude" step="any" placeholder="e.g. -6.2088">
                        </div>
                        <div>
                            <label for="businessLongitude">Longitude</label>
                            <input type="number" id="businessLongitude" name="longitude" step="any" placeholder="e.g. 106.8456">
                        </div>
                    </div>
                    
                    <div class="form-row two-col">
                        <div>
                            <label for="businessOpenTime">Opening Time</label>
                            <input type="time" id="businessOpenTime" name="openTime">
                        </div>
                        <div>
                            <label for="businessCloseTime">Closing Time</label>
                            <input type="time" id="businessCloseTime" name="closeTime">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label for="businessWebsite">Website</label>
                        <input type="url" id="businessWebsite" name="website" placeholder="https://...">
                    </div>
                    
                    <div class="form-row">
                        <label for="businessEmail">Email</label>
                        <input type="email" id="businessEmail" name="email" placeholder="Enter business email">
                    </div>
                    
                    <div class="form-row">
                        <label for="businessKeywords">Keywords (comma separated)</label>
                        <input type="text" id="businessKeywords" name="keywords" placeholder="e.g. food, delivery, italian">
                    </div>
                    
                    <div class="form-row">
                        <label class="checkbox-label">
                            <input type="checkbox" id="businessFeatured" name="featured">
                            <span>Featured Business</span>
                        </label>
                    </div>
                    
                    <!-- <div class="form-row">
                        <label>Business Images</label>
                        <div class="image-upload-container">
                            <div class="image-upload-box" onclick="document.getElementById('businessImage').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload</p>
                            </div>
                            <input type="file" id="businessImage" name="image" accept="image/*" style="display: none" onchange="previewImage(this)">
                            <div id="imagePreview" class="image-preview"></div>
                        </div>
                    </div> -->
                    <div class="form-note" style="margin: 15px 0; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                        <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                        <span>Images can be added after creating the business through the edit menu.</span>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="action-btn btn-secondary" onclick="closeAdminModal()">Cancel</button>
                        <button type="submit" class="action-btn btn-primary">
                            <i class="fas fa-plus-circle"></i> Add Business
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Manage Listings Tab -->
            <div class="admin-tab-content" id="manage-listings-content">
                <div class="admin-search">
                    <input type="text" id="adminSearchInput" placeholder="Search businesses...">
                    <button class="admin-search-btn" onclick="searchAdminBusinesses()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminBusinessList">
                            <!-- Business list will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="admin-pagination">
                    <button onclick="changePage(-1)" class="pagination-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="currentPage">Page 1</span>
                    <button onclick="changePage(1)" class="pagination-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Categories Tab -->
            <div class="admin-tab-content" id="categories-content">
                <div class="admin-category-actions">
                    <button class="action-btn btn-primary" onclick="showAddCategoryForm()">
                        <i class="fas fa-plus-circle"></i> Add Category
                    </button>
                </div>
                
                <div id="categoryFormContainer" style="display: none;">
                    <form id="addCategoryForm" class="admin-form">
                        <div class="form-row">
                            <label for="categoryName">Category Name *</label>
                            <input type="text" id="categoryName" name="name" required placeholder="Enter category name">
                        </div>
                        
                        <div class="form-row">
                            <label for="categoryIcon">Icon (Emoji) *</label>
                            <input type="text" id="categoryIcon" name="icon" required placeholder="E.g. üçî">
                        </div>
                        
                        <div class="form-row">
                            <label for="categoryDescription">Description</label>
                            <textarea id="categoryDescription" name="description" placeholder="Describe the category"></textarea>
                        </div>
                        
                        <div class="form-note" style="margin: 15px 0; padding: 10px; background-color: rgba(99, 102, 241, 0.1); border-radius: 6px;">
                            <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                            <span>Subcategories can be added after creating the category using the edit option.</span>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="action-btn btn-secondary" onclick="hideAddCategoryForm()">Cancel</button>
                            <button type="submit" class="action-btn btn-primary">
                                <i class="fas fa-plus-circle"></i> Add Category
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Icon</th>
                                <th>Name</th>
                                <th>Subcategories</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminCategoryList">
                            <!-- Category list will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Subcategories Tab -->
            <div class="admin-tab-content" id="manage-subcategories-content">
                <div id="subcategoryListContainer">
                <div class="admin-section-header">
                    <button class="action-btn btn-primary" onclick="showAddSubcategoryForm()">
                        <i class="fas fa-plus-circle"></i> Add Subcategory
                    </button>
                </div>

                <!-- Filter Controls -->
                <div class="filter-controls">
                    <div class="filter-row">
                        <label for="filterCategory">Filter by Category:</label>
                        <select id="filterCategory" onchange="filterSubcategories()">
                            <option value="">All Categories</option>
                            <!-- Categories will be loaded here -->
                        </select>
                        
                        <div class="search-box">
                            <input type="text" id="searchSubcategory" placeholder="Search subcategories..." 
                                   oninput="filterSubcategories()">
                            <button class="search-btn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                </div>
                 <!-- Subcategories Table -->
                 <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminSubcategoryList">
                            <!-- Subcategories will be loaded here -->
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px;">
                                    <div class="loading" style="display: inline-block;"></div>
                                    <p style="margin-top: 10px;">Loading subcategories...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="pagination-controls">
                    <button id="subcategoryPrevPageBtn" class="action-btn btn-secondary" onclick="changeSubcategoryPage(-1)" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span id="subcategoryPageInfo">Page 1</span>
                    <button id="subcategoryNextPageBtn" class="action-btn btn-secondary" onclick="changeSubcategoryPage(1)" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                 
                <!-- Add Subcategory Form -->
                <div id="addSubcategoryFormContainer" style="display: none;">
                    <div class="admin-section-header">
                        <h2>Add New Subcategory</h2>
                    </div>
                    
                    <form id="addSubcategoryForm" class="admin-form">
                        <div class="form-row">
                            <label for="subcategoryName">Subcategory Name *</label>
                            <input type="text" id="subcategoryName" name="name" required placeholder="Enter subcategory name">
                        </div>
                        
                        <div class="form-row">
                            <label for="subcategorySlug">Slug (URL Friendly)</label>
                            <input type="text" id="subcategorySlug" name="slug" maxlength="100" 
                                   placeholder="Will be generated automatically if empty">
                            <small class="form-hint">Used in URLs, maximum 100 characters, lowercase letters, numbers and hyphens only</small>
                        </div>
                        
                        <div class="form-row">
                            <label for="subcategoryDescription">Description</label>
                            <textarea id="subcategoryDescription" name="description" rows="3" placeholder="Describe the subcategory"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <label for="subcategoryCategory">Parent Category *</label>
                            <select id="subcategoryCategory" name="categoryId" required>
                                <option value="">Select a category</option>
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="action-btn btn-secondary" onclick="hideAddSubcategoryForm()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="submit" class="action-btn btn-primary">
                                <i class="fas fa-plus-circle"></i> Add Subcategory
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Edit Subcategory Form -->
                <div id="editSubcategoryFormContainer" style="display: none;">
                    <div class="admin-section-header">
                        <h2>Edit Subcategory</h2>
                    </div>
                    
                    <form id="editSubcategoryForm" class="admin-form">
                        <input type="hidden" id="editSubcategoryId" name="id">
                        
                        <div class="form-row">
                            <label for="editSubcategoryName">Subcategory Name *</label>
                            <input type="text" id="editSubcategoryName" name="name" required placeholder="Enter subcategory name">
                        </div>
                        
                        <div class="form-row">
                            <label for="editSubcategorySlug">Slug (URL Friendly)</label>
                            <input type="text" id="editSubcategorySlug" name="slug" maxlength="100" 
                                   placeholder="Will be generated automatically if empty">
                            <small class="form-hint">Used in URLs, maximum 100 characters, lowercase letters, numbers and hyphens only</small>
                        </div>
                        
                        <div class="form-row">
                            <label for="editSubcategoryDescription">Description</label>
                            <textarea id="editSubcategoryDescription" name="description" rows="3" placeholder="Describe the subcategory"></textarea>
                        </div>
                          
                        <div class="form-row">
                            <label for="editSubcategoryCategory">Parent Category *</label>
                            <select id="editSubcategoryCategory" name="categoryId" required>
                                <option value="">Select a category</option>
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="action-btn btn-secondary" onclick="hideEditSubcategoryForm()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="submit" class="action-btn btn-primary">
                                <i class="fas fa-save"></i> Update Subcategory
                            </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Login Modal -->
<div class="modal" id="adminLoginModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Admin Login</h2>
            <button class="modal-close" onclick="closeAdminLoginModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="adminLoginForm" onsubmit="handleAdminLogin(event)">
            <div class="form-row">
                <label for="adminUsername">Username</label>
                <input type="text" id="adminUsername" required placeholder="Enter your username">
            </div>
            
            <div class="form-row">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" required placeholder="Enter your password">
            </div>
            
            <div id="adminLoginError" class="form-error"></div>
            
            <div class="form-actions">
                <button type="button" class="action-btn btn-secondary" onclick="closeAdminLoginModal()">Cancel</button>
                <button type="submit" class="action-btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
        </form>
    </div>
</div>

    <!-- External Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>

    <script>
        // Update API Base URL to use the relative path since we're serving from the same NestJS server
        const API_BASE_URL = '/api';
        
        // App state
        let currentPage = 'home';
        let currentCategory = 'all';
        let currentSubcategory = 'all';
        let categories = [];
        let businesses = [];
        let filteredBusinesses = [];
        let searchTimeout;
    
        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');
        const searchResults = document.getElementById('searchResults');

        const DEBUG = true; // Set ke false untuk production

// Fungsi debug log
function debugLog(...args) {
    if (DEBUG) {
        console.log('[DEBUG]', ...args);
    }
}

// Update variabel global
let currentSearchQuery = null; // Untuk menyimpan query pencarian aktif

    // ...existing code...

    // Initialize app
    async function init() {
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
        
        // Show loading state
        showLoading();
        
        try {
            // Setup event listeners first to enable user interaction
            setupEventListeners();
            
            // Check if user is logged in
            if (isLoggedIn() || isLoggedInAdmin()) {
                updateUserInterface(true);
            } else {
                updateUserInterface(false);
            }
            
            // Fetch categories from API
            await fetchCategories();
            debugLog('Categories after fetch:', categories);
            
            if (!categories || categories.length === 0) {
                showError('No categories available. Please try again later.');
                return;
            }
            
            // Fetch initial businesses only after categories are loaded
            await fetchBusinesses();
            
            // Fetch stats if available
            try {
                await fetchStats();
            } catch (statsError) {
                console.warn('Stats could not be loaded, using defaults', statsError);
                updateHomeStats({
                    businessCount: businesses.length,
                    categoryCount: categories.length,
                    averageRating: 4.5
                });
            }
            
            // Render categories
            renderCategories();
            
            // Show home page
            showPage('home');
        } catch (error) {
            console.error('Error initializing app:', error);
            showError('Failed to load data. Please try again later.');
        } finally {
            hideLoading();
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('focus', handleSearchFocus);
        searchInput.addEventListener('blur', handleSearchBlur);
        searchClear.addEventListener('click', clearSearch);
        
        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                hideSearchResults();
            }
        });
        
        // Close modal when clicking outside
        document.getElementById('businessModal').addEventListener('click', (e) => {
            if (e.target.id === 'businessModal') closeModal();
        });
        
        // Handle error toast clicks
        document.addEventListener('click', (e) => {
            if (e.target.closest('.error-toast')) {
                e.target.closest('.error-toast').remove();
            }
        });
        
        // Listen for network status changes
        window.addEventListener('online', () => {
            console.log('Back online, refreshing data...');
            if (currentPage === 'home') {
                init();
            } else if (currentPage === 'listings') {
                renderListings();
            }
        });
    }

    // ...existing code...
        // Check if user is logged in    
        // Show loading state
        function showLoading() {
            document.getElementById('categoriesGrid').innerHTML = `
                <div style="text-align: center; padding: 40px; grid-column: span 2;">
                    <div class="loading"></div>
                    <p style="margin-top: 10px; color: var(--text-secondary);">Loading...</p>
                </div>
            `;
        }
        
        // Hide loading state
        function hideLoading() {
            // Loading state will be replaced by content
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('categoriesGrid').innerHTML = `
                <div style="text-align: center; padding: 40px; grid-column: span 2;">
                    <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                    <p style="margin-bottom: 20px; color: var(--text-primary); font-weight: 600;">${message}</p>
                    <button class="action-btn btn-primary" style="display: inline-block;" onclick="init()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    
        // Handle API errors
        function handleApiError(error, defaultReturnValue = []) {
            console.error('API Error:', error.message || 'Unknown error');
            
            // Untuk user interface, tampilkan toast atau notifikasi error
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-toast';
            errorMessage.innerHTML = `
                <div class="error-toast-content">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Error: ${error.message || 'Failed to connect to server'}</span>
                </div>
            `;
            document.body.appendChild(errorMessage);
            
            // Hilangkan setelah 3 detik
            setTimeout(() => {
                errorMessage.classList.add('hide');
                setTimeout(() => errorMessage.remove(), 300);
            }, 3000);
            
            return defaultReturnValue;
        }

    async function fetchCategories() {
    try {
        debugLog('Fetching categories...');
        const response = await fetch(`${API_BASE_URL}/categories`);
        if (!response.ok) {
            throw new Error(`Failed to fetch categories: ${response.status} ${response.statusText}`);
        }
        
        let data = await response.json();
        debugLog('Raw categories data:', data);
        
        // Jika data adalah array, gunakan langsung
        // Jika data memiliki property 'data' yang berisi array, gunakan itu
        if (data.data && Array.isArray(data.data)) {
            data = data.data;
        } else if (!Array.isArray(data)) {
            debugLog('Invalid categories format:', data);
            return [];
        }
        
        // Filter kategori yang tidak valid dan proses data
        data = data.filter(cat => cat && cat.name && cat.name !== "string" && cat.name.trim() !== "").map(cat => {
            // Pastikan subcategories ada dan dalam format yang diharapkan
            let subcategories = [];
            
            if (cat.subcategories) {
                // Jika subcategories adalah string JSON, parse
                if (typeof cat.subcategories === 'string') {
                    try {
                        subcategories = JSON.parse(cat.subcategories);
                    } catch (e) {
                        debugLog('Error parsing subcategories string:', e);
                        subcategories = [];
                    }
                } 
                 // Jika subcategories sudah array, gunakan
                 else if (Array.isArray(cat.subcategories)) {
                    subcategories = cat.subcategories;
                }
            }
            
            // Konversi subcategories ke format yang konsisten
            subcategories = subcategories.map(sub => {
                if (typeof sub === 'string') {
                    return { id: sub, name: sub };
                } else if (typeof sub === 'object' && sub !== null) {
                    return { 
                        id: sub.id || sub._id || '', 
                        name: sub.name || 'Subcategory' 
                    };
                }
                return { id: '', name: 'Subcategory' };
            });
            
            return {
                id: cat.id || cat._id,
                name: cat.name,
                icon: cat.icon || 'üìÅ',
                count: cat.count || 0,
                subcategories: subcategories
            };
        });
        
        debugLog('Processed categories:', data);
        categories = data;
        return categories;
    } catch (error) {
        console.error('Error fetching categories:', error);
        throw error; // Re-throw to let init() handle it
    }
}


    
        // Fetch businesses from API (untuk all businesses)
        async function fetchBusinesses() {
            try {
                const response = await fetch(`${API_BASE_URL}/businesses?limit=10&offset=0&sortBy=createdAt&sortOrder=DESC`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch businesses: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Ensure we have an array - API might return {data: [...]}
                if (!data) {
                    console.warn('Received empty data for businesses');
                    businesses = [];
                    filteredBusinesses = [];
                    return [];
                }
                
                // Handle API response structure
                const businessArray = data.data && Array.isArray(data.data) ? data.data : 
                                    (Array.isArray(data) ? data : []);
                
                businesses = businessArray;
                filteredBusinesses = [...businesses];
                return businesses;
            } catch (error) {
                console.error('Error fetching businesses:', error);
                // Don't throw here, just return empty array
                businesses = [];
                filteredBusinesses = [];
                return [];
            }
        }
        
        // Fetch businesses by category
        async function fetchBusinessesByCategory(categoryId) {
            try {
                const response = await fetch(`${API_BASE_URL}/businesses?category=${categoryId}&limit=10&offset=0&sortBy=createdAt&sortOrder=DESC`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch businesses by category: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Check if data is in expected format (might be wrapped in a data property)
                const businessesData = data.data ? data.data : data;
                
                filteredBusinesses = businessesData;
                return businessesData;
            } catch (error) {
                return handleApiError(error, []);
            }
        }

        // Fetch user favorites
        async function fetchUserFavorites() {
            try {
                // Cek apakah user sudah login
                if (!isLoggedIn() && !isLoggedInAdmin()) {
        // Tampilkan pesan login required di favoritesContent
            document.getElementById('favoritesContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üîê</div>
                    <div class="empty-title">Login Required</div>
                    <p>Please login to add businesses to your favorites</p>
                    <button class="action-btn btn-primary" style="margin-top: 20px;" onclick="showPage('profile')">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            `;
            return;
                } else if (isLoggedInAdmin()) {
                    // Jika admin yang login, tampilkan pesan khusus
                    document.getElementById('favoritesContent').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üîê</div>
                            <div class="empty-title">ADMIN</div>
                            <p>This is a User Page</p>
                        </div>
                    `;
                    return;
                }
            
            // Tampilkan loading state di favoritesContent
            document.getElementById('favoritesContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading"></div>
                    <p style="margin-top: 10px; color: var(--text-secondary);">Loading your favorites...</p>
                </div>
            `;
            
            // Fetch data favorites dari API
            const response = await fetch(`${API_BASE_URL}/user/favorites`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch favorites');
            }
            
            const favorites = await response.json();
            
            // Jika tidak ada favorites
            if (favorites.length === 0) {
                document.getElementById('favoritesContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üíù</div>
                        <div class="empty-title">No favorites yet</div>
                        <p>Start adding businesses to your favorites!</p>
                    </div>
                `;
                return;
            }
            
            // Jika ada favorites, tampilkan daftarnya
            document.getElementById('favoritesContent').innerHTML = `
                <div class="businesses-list" id="favoritesList"></div>
            `;
            
            // Update subtitle untuk menampilkan jumlah favorites
            document.querySelector('#favoritesPage .listings-subtitle').textContent = 
                `${favorites.length} saved businesses`;
            
            // Render favorites
            const favoritesList = document.getElementById('favoritesList');
            favoritesList.innerHTML = favorites.map((business, index) => {
                const imageUrl = business.images && business.images.length > 0 
                    ? business.images[0] 
                    : '/api/placeholder/300/160';
                    
                return `
                    <div class="business-card" onclick="openModal('${business.id}')" 
                        data-aos="fade-up" data-aos-delay="${index * 100}">
                        <img src="${imageUrl}" alt="${business.name}" class="business-image">
                        <div class="business-content">
                            <div class="business-header">
                                <div class="business-info">
                                    <h3>${business.name}</h3>
                                    <div class="business-category">${business.categoryDisplay || 'Business'}</div>
                                </div>
                                <div class="business-rating">
                                    <span class="rating-stars">‚≠ê</span>
                                    <span>${business.rating || '0.0'}</span>
                                </div>
                            </div>
                            <div class="business-details">
                                <div class="business-detail">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${business.address || 'Address not available'}
                                </div>
                                <div class="business-detail">
                                    <i class="fas fa-phone"></i>
                                    ${business.phone || 'Phone not available'}
                                </div>
                            </div>
                            <div class="business-actions">
                                <button class="action-btn btn-primary" onclick="event.stopPropagation(); window.location.href='tel:${business.phone}'">
                                    <i class="fas fa-phone"></i> Call
                                </button>
                                <button class="action-btn btn-danger" onclick="event.stopPropagation(); removeFavorite('${business.id}')">
                                    <i class="fas fa-heart-broken"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Re-initialize AOS for new elements
            setTimeout(() => AOS.refresh(), 100);
            
        } catch (error) {
            console.error('Error fetching favorites:', error);
            document.getElementById('favoritesContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <div class="empty-title">Error loading favorites</div>
                    <p>Please try again later</p>
                    <button class="action-btn btn-primary" style="margin-top: 15px;" onclick="fetchUserFavorites()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

        function removeFavorite(businessId, event) {
        // Ini adalah fungsi alias untuk memastikan backward compatibility
            return removeFromFavorites(businessId, event);
        }

        // User login
        async function loginUser(email, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });

                                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Login failed');
                }
                
                const userData = await response.json();
                console.log('User data:', userData);
                
                
                // Store user data and token
                localStorage.setItem('user', JSON.stringify(userData.user));
                localStorage.setItem('token', userData.token);
                
                return userData;
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }

        // Check if user is logged in
        function isLoggedIn() {
            return !!localStorage.getItem('token');
        }

        function isLoggedInAdmin() {
            return !!localStorage.getItem('adminToken');
        }

        
        
        
        // Update UI based on login state
        function updateUserInterface(isLoggedIn, isLoggedInAdmin) {
 
        if (isLoggedInAdmin) {
        // Update UI for admin logged-in state
        profileBtn.innerHTML = '<i class="fas fa-user-shield"></i>';
        // Get user data
        const user = JSON.parse(localStorage.getItem('adminUser')) || {};
        
        const username = user.username || 'Admin';
        const email = user.email || '';
        
        // Update profile page with user information
        document.getElementById('profilePage').innerHTML = `
            <div class="listings-header">
                <h2 class="listings-title">Your Profile</h2>
                <p class="listings-subtitle">Welcome back, Admin ${username}!</p>
            </div>
            <div style="padding: 20px;">
                <div class="profile-info">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-name">${username}</div>
                    <div class="profile-email">${email}</div>
                </div>
                
                <div class="profile-actions">
                    <button class="action-btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="showPage('favorites')">
                        <i class="fas fa-heart"></i> My Favorites
                    </button>
                    <button class="action-btn btn-danger" style="width: 100%;" onclick="logoutUser()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        `;

        const profileStyle = document.createElement('style');
        profileStyle.textContent = `
            .profile-info {
                text-align: center;
                margin-bottom: 30px;
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: var(--bg-secondary);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 35px;
                color: var(--primary);
                margin: 0 auto 15px;
                border: 3px solid var(--primary);
            }
            
            .profile-name {
                font-size: 24px;
                font-weight: 700;
                margin-bottom: 5px;
                color: var(--text-primary);
            }
            
            .profile-email {
                font-size: 16px;
                color: var(--text-secondary);
                margin-bottom: 25px;
            }
            
            .profile-actions {
                border-top: 1px solid var(--border);
                padding-top: 25px;
            }
        `;
        document.head.appendChild(profileStyle);
        } else if (isLoggedIn) {    
        // Update UI for logged-in state
        profileBtn.innerHTML = '<i class="fas fa-user-check"></i>';
        
        // Get user data
        const user = JSON.parse(localStorage.getItem('user')) || {};
        const username = user.username || 'User';
        const email = user.email || '';
        
        // Update profile page with user information
        document.getElementById('profilePage').innerHTML = `
            <div class="listings-header">
                <h2 class="listings-title">Your Profile</h2>
                <p class="listings-subtitle">Welcome back, ${username}!</p>
            </div>
            <div style="padding: 20px;">
                <div class="profile-info">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-name">${username}</div>
                    <div class="profile-email">${email}</div>
                </div>
                
                <div class="profile-actions">
                    <button class="action-btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="showPage('favorites')">
                        <i class="fas fa-heart"></i> My Favorites
                    </button>
                    <button class="action-btn btn-danger" style="width: 100%;" onclick="logoutUser()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        `;

        const profileStyle = document.createElement('style');
        profileStyle.textContent = `
            .profile-info {
                text-align: center;
                margin-bottom: 30px;
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: var(--bg-secondary);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 35px;
                color: var(--primary);
                margin: 0 auto 15px;
                border: 3px solid var(--primary);
            }
            
            .profile-name {
                font-size: 24px;
                font-weight: 700;
                margin-bottom: 5px;
                color: var(--text-primary);
            }
            
            .profile-email {
                font-size: 16px;
                color: var(--text-secondary);
                margin-bottom: 25px;
            }
            
            .profile-actions {
                border-top: 1px solid var(--border);
                padding-top: 25px;
            }
        `;
        document.head.appendChild(profileStyle);
        
        } else {

            const profileBtn = document.querySelector('.profile-btn');
                
               // Update profile page to show login forms with tabs
            document.getElementById('profilePage').innerHTML = `
                <div class="listings-header">
                    <h2 class="listings-title">Your Profile</h2>
                    <p class="listings-subtitle">Login to your account</p>
                </div>
                <div style="padding: 20px;">
                    <div class="login-tabs">
                        <div class="login-tab active" id="userLoginTab" onclick="switchLoginTab('user')">User Login</div>
                        <div class="login-tab" id="adminLoginTab" onclick="switchLoginTab('admin')">Admin Login</div>
                    </div>
                    
                    <div id="userLoginForm" class="login-form active">
                        <form onsubmit="handleLogin(event)">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Username</label>
                                <input type="text" id="adminUsername" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Password</label>
                                <input type="password" id="adminPassword" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                            </div>
                            <button type="submit" class="action-btn btn-primary" style="width: 100%;">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>
                            <p style="text-align: center; margin-top: 15px; color: var(--text-secondary);">
                                Don't have an account? <a href="#" onclick="showRegisterForm()" style="color: var(--primary);">Register</a>
                            </p>
                            <div id="userLoginError" style="color: var(--danger); margin-top: 15px; text-align: center; display: none;"></div>
                        </form>
                    </div>
                    
                    <div id="adminLoginForm" class="login-form">
                        <form onsubmit="handleAdminLogin(event)">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Admin Username</label>
                                <input type="text" id="adminUsername2" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Admin Password</label>
                                <input type="password" id="adminPassword2" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                            </div>
                            <button type="submit" class="action-btn btn-primary" style="width: 100%; background-color: #8b5cf6;">
                                <i class="fas fa-lock"></i> Login as Admin
                            </button>
                            <div id="adminLoginError2" style="color: var(--danger); margin-top: 15px; text-align: center; display: none;"></div>
                        </form>
                    </div>
                </div>
            `;
    
            // Add styles for tabs
            const loginTabsStyle = document.createElement('style');
            loginTabsStyle.textContent = `
                .login-tabs {
                    display: flex;
                    margin-bottom: 20px;
                    border-bottom: 1px solid var(--border);
                }
                
                .login-tab {
                    padding: 10px 15px;
                    cursor: pointer;
                    font-weight: 500;
                    text-align: center;
                    flex: 1;
                    color: var(--text-secondary);
                    transition: all 0.3s ease;
                }
                
                .login-tab.active {
                    color: var(--primary);
                    border-bottom: 2px solid var(--primary);
                }
                
                .login-form {
                    display: none;
                }
                
                .login-form.active {
                    display: block;
                    animation: fadeIn 0.3s ease;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `;
            document.head.appendChild(loginTabsStyle);
    
            // Modify handleAdminLogin for the profile tab version
            function handleAdminLoginFromProfile(event) {
                event.preventDefault();
                
                const username = document.getElementById('adminUsername2').value.trim();
                const password = document.getElementById('adminPassword2').value;
                const errorElement = document.getElementById('adminLoginError2');
                
                // Reset error
                errorElement.style.display = 'none';
                
                // Simple validation
                if (!username || !password) {
                    errorElement.textContent = 'Please enter both username and password';
                    errorElement.style.display = 'block';
                    return;
                }
                
                // Use the existing handleAdminLogin functionality
                try {
                    // Show loading
                    const submitBtn = event.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
                    submitBtn.disabled = true;
                    
                    // Call API with async/await
                    (async () => {
                        try {
                            const response = await fetch(`${API_BASE_URL}/auth/admin/login`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ username, password })
                            });
                            
                            if (!response.ok) {
                                const error = await response.json();
                                throw new Badrequ(error.message || 'Invalid credentials 1');
                            }
                            
                            const data = await response.json();
                            
                            // Store token
                            localStorage.setItem('adminToken', data.token);
                            localStorage.setItem('adminUser', JSON.stringify(data.user));
                            
                            // Open admin panel
                            openAdminModal();
                            
                            // Show success toast
                            showToast('Admin login successful', 'success');
                            
                        } catch (error) {
                            // Show error
                            errorElement.textContent = error.message || 'Login failed';
                            errorElement.style.display = 'block';
                            console.error('Admin login error:', error);
                        } finally {
                            // Restore button
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }
                    })();
                } catch (error) {
                    // Handle synchronous errors
                    errorElement.textContent = error.message || 'An unexpected error occurred';
                    errorElement.style.display = 'block';
                }
              }
           }
           updateFloatingAddButton();
        }


        // Function to switch between login tabs
        function switchLoginTab(tab) {
            // Update tabs
            document.getElementById('userLoginTab').classList.toggle('active', tab === 'user');
            document.getElementById('adminLoginTab').classList.toggle('active', tab === 'admin');
            
            // Update forms
            document.getElementById('userLoginForm').classList.toggle('active', tab === 'user');
            document.getElementById('adminLoginForm').classList.toggle('active', tab === 'admin');
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/businesses/stats`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch stats: ${response.status} ${response.statusText}`);
                }

                console.log(response);
                
                
                const stats = await response.json();
                
                updateHomeStats(stats);
            } catch (error) {
                console.error('Error fetching stats:', error);
                // Use default stats if API fails
                updateHomeStats({
                    businessCount: businesses.length,
                    categoryCount: categories.length,
                    averageRating: 4.5
                });
            }
        }

        // Update home page statistics
        function updateHomeStats(stats) {

            console.log(1, 'Updating home stats with:', stats);
            
            // Dapatkan elemen stats grid
            const statsGrid = document.querySelector('.stats-grid');
            if (!statsGrid) return;
            

            const user = JSON.parse(localStorage.getItem('adminUser')) || {};
            const isAdmin = user.role === 'admin';
            
            // if (isAdmin) {                
            //     // Admin melihat stats yang lebih lengkap
            //     const totalBusinesses = stats?.totalBusinesses || businesses?.length || 0;
            //     const activeBusinesses = stats?.activeBusinesses || totalBusinesses || 0;
            //     const featuredBusinesses = stats?.featuredBusinesses || 0;
            //     const totalCategories = stats?.totalCategories || categories?.length || 0;
            //     const totalSubcategories = stats?.totalSubcategories || 0;
            //     const totalUsers = stats?.totalUsers || 0;
            //     const totalAdmins = stats?.totalAdmins || 1;
                
            //     // Update CSS untuk grid layout yang lebih besar
            //     statsGrid.style.gridTemplateColumns = 'repeat(4, 1fr)';
                
            //     // Update stats grid dengan nilai yang valid dan lebih banyak data
            //     statsGrid.innerHTML = `
            //       <div class="stat-card" data-aos="fade-up" data-aos-delay="100">
            //         <div class="stat-number">${totalBusinesses}</div>
            //         <div class="stat-label">Total Businesses</div>
            //     </div>
            //     <div class="stat-card" data-aos="fade-up" data-aos-delay="150">
            //         <div class="stat-number">${activeBusinesses}</div>
            //         <div class="stat-label">Active Businesses</div>
            //     </div>
            //     <div class="stat-card" data-aos="fade-up" data-aos-delay="200">
            //         <div class="stat-number">${featuredBusinesses}</div>
            //         <div class="stat-label">Featured</div>
            //     </div>
            //     <div class="stat-card" data-aos="fade-up" data-aos-delay="250">
            //         <div class="stat-number">${totalCategories}</div>
            //         <div class="stat-label">Categories</div>
            //     </div>
            //     <div class="stat-card" data-aos="fade-up" data-aos-delay="300">
            //         <div class="stat-number">${totalSubcategories}</div>
            //         <div class="stat-label">Subcategories</div>
            //     </div>
            //     <div class="stat-card" data-aos="fade-up" data-aos-delay="350">
            //         <div class="stat-number">${totalUsers}</div>
            //         <div class="stat-label">Users</div>
            //     </div>
            //     <div class="stat-card" data-aos="fade-up" data-aos-delay="400">
            //         <div class="stat-number">${totalAdmins}</div>
            //         <div class="stat-label">Admins</div>
            //     </div>
            //     <div class="stat-card manage-card" data-aos="fade-up" data-aos-delay="450" onclick="showAdminPanel('businesses')">
            //         <div class="stat-icon"><i class="fas fa-cog"></i></div>
            //         <div class="stat-label">Manage Data</div>
            //     </div>
            // `;

            // const styleElement = document.createElement('style');
            // styleElement.textContent = `
            //     .stat-card.manage-card {
            //         background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            //         color: white;
            //         cursor: pointer;
            //         transition: all 0.3s ease;
            //     }
                
            //     .stat-card.manage-card:hover {
            //         transform: translateY(-8px) scale(1.05);
            //         box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
            //     }
                
            //     .stat-icon {
            //         font-size: 24px;
            //         margin-bottom: 8px;
            //     }
                
            //     .stat-card.manage-card .stat-label {
            //         color: white;
            //         font-weight: 600;
            //     }
            // `;
            // document.head.appendChild(styleElement);
            
            // } else {

            // }
            // Pastikan stats memiliki data yang valid
            const businessCount = stats?.businessCount || businesses?.length || 0;
            const categoryCount = stats?.categoryCount || categories?.length || 0;
            const averageRating = stats?.averageRating || 4.5;
            
            // Update stats grid dengan nilai yang valid
            statsGrid.innerHTML = `
                <div class="stat-card" data-aos="fade-up" data-aos-delay="100">
                    <div class="stat-number">${businessCount}+</div>
                    <div class="stat-label">Businesses</div>
                </div>
                <div class="stat-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="stat-number">${categoryCount}</div>
                    <div class="stat-label">Categories</div>
                </div>
                <div class="stat-card" data-aos="fade-up" data-aos-delay="300">
                    <div class="stat-number">${typeof averageRating === 'number' ? averageRating.toFixed(1) : '4.5'}</div>
                    <div class="stat-label">Avg Rating</div>
                </div>
            `;
            
        }
                
        // Fetch businesses by subcategory
        async function fetchBusinessesBySubcategory(categoryId, subcategoryId) {
            try {
                const response = await fetch(`${API_BASE_URL}/businesses?category=${categoryId}&subcategory=${subcategoryId}&limit=10&offset=0&sortBy=createdAt&sortOrder=DESC`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch businesses by subcategory: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Check if data is in expected format
                const businessesData = data.data ? data.data : data;
                
                filteredBusinesses = businessesData;
                return businessesData;
            } catch (error) {
                return handleApiError(error, []);
            }
        }
        
        // Fetch business detail
        async function fetchBusinessDetail(businessId) {
            try {
                const response = await fetch(`${API_BASE_URL}/businesses/${businessId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch business detail: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                return handleApiError(error, {});
            }
        }
        
        // Search businesses - juga ubah format parameter untuk konsistensi
        async function searchBusinesses(query, options = {}) {
    try {
        // Default options
        const defaults = {
            limit: 10,
            offset: 0,
            sortBy: 'relevance', // 'relevance', 'name', 'rating', 'createdAt'
            category: null,
            subcategory: null
        };
        
        // Gabungkan options dengan defaults
        const settings = { ...defaults, ...options };
        
        // Build query string
        let queryParams = `q=${encodeURIComponent(query)}`;
        queryParams += `&limit=${settings.limit}`;
        queryParams += `&offset=${settings.offset}`;
        queryParams += `&sortBy=${settings.sortBy}`;
        
        if (settings.category) {
            queryParams += `&category=${settings.category}`;
        }
        
        if (settings.subcategory) {
            queryParams += `&subcategory=${settings.subcategory}`;
        }
        
        debugLog('Search query params:', queryParams);
        
            
            // Fetch results
            // Fetch results
        const response = await fetch(`${API_BASE_URL}/search?${queryParams}`);
        
        if (!response.ok) {
            throw new Error(`Search failed: ${response.status} ${response.statusText}`);
        }
        
        const results = await response.json();
        debugLog('Search results:', results);
        
        return results;
    } catch (error) {
        console.error('Search error:', error);
        return { data: [], categories: [], total: 0, page: 1, limit: 10, query };
    }
}



// Render search results page
function renderSearchResultsPage(searchResults, query) {
    // Check if we're in the listings page
    if (currentPage !== 'listings') {
        showPage('listings', 'all');
    }
    
    const listingsContainer = document.getElementById('listingsContainer');
    
    // Set page title and subtitle
    document.getElementById('listingsTitle').textContent = `Search Results: "${query}"`;
    document.getElementById('listingsSubtitle').textContent = 
        `Found ${searchResults.total} result${searchResults.total !== 1 ? 's' : ''}`;
    
    // Jika ada kategori yang cocok, tampilkan di bagian atas
    if (searchResults.categories && searchResults.categories.length > 0) {
        const categoriesSection = document.createElement('div');
        categoriesSection.className = 'search-categories-section';
        categoriesSection.innerHTML = `
            <h3 class="section-title">Matching Categories</h3>
            <div class="category-cards">
                ${searchResults.categories.map(category => `
                    <div class="category-card compact" onclick="showPage('listings', '${category.id}')">
                        <span class="category-icon">${category.icon || 'üìÅ'}</span>
                        <div class="category-name">${category.name}</div>
                        <div class="category-count">${category.count || 0} businesses</div>
                    </div>
                `).join('')}
            </div>
        `;
        
        // Tambahkan section kategori sebelum daftar bisnis
        const businessesList = document.getElementById('businessesList');
        if (businessesList) {
            listingsContainer.insertBefore(categoriesSection, businessesList.parentNode);
        }
    }
     // Update filteredBusinesses dan render bisnis
     filteredBusinesses = searchResults.data;
    renderBusinessesList();
    
    // Scroll ke atas halaman
    window.scrollTo(0, 0);
}




        async function getSearchSuggestions(query) {
            if (!query || query.length < 3) return [];
            
            try {
                const response = await fetch(`${API_BASE_URL}/search/suggestions?q=${encodeURIComponent(query)}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to get suggestions: ${response.status} ${response.statusText}`);
                }
                
                const suggestions = await response.json();
                return suggestions;
            } catch (error) {
                console.error('Suggestion error:', error);
                return [];
            }
        }

        // Fetch business detail
        async function fetchBusinessDetail(businessId) {
            try {
                const response = await fetch(`${API_BASE_URL}/businesses/${businessId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch business detail: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                return handleApiError(error, {});
            }
        }
    
        // Handle search input
        function handleSearchInput() {
        const query = searchInput.value.trim();
            
        // Show/hide clear button
        searchClear.style.display = query ? 'flex' : 'none';
        
        // Clear previous timeout
        if (searchTimeout) clearTimeout(searchTimeout);
        
        // Debounce search
        searchTimeout = setTimeout(async () => {
            if (query.length > 2) {
                try {
                    // Tampilkan loading di search results
                    searchResults.innerHTML = `
                        <div class="search-result-item">
                            <div class="search-result-icon">
                                <div class="loading-small"></div>
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-meta">Searching...</div>
                            </div>
                        </div>
                    `;
                    searchResults.style.display = 'block';
                    
                    // Dapatkan saran pencarian (jika ada)
                    const suggestions = await getSearchSuggestions(query);
                    
                    // Fetch search results dengan sortBy=relevance untuk hasil terbaik
                    const results = await searchBusinesses(query, {
                        limit: 5,
                        sortBy: 'relevance',
                        category: currentCategory !== 'all' ? currentCategory : null,
                        subcategory: currentSubcategory !== 'all' ? currentSubcategory : null
                    });
                        
                    // Format hasil dan tampilkan
                    displaySearchResults(formatSearchResults(results, query, suggestions));
                    
                    // Jika di halaman listings, update tampilan
                    if (currentPage === 'listings') {
                        // Simpan query untuk referensi
                        currentSearchQuery = query;
                        
                        // Update tampilan listings dengan hasil pencarian
                        filteredBusinesses = results.data;
                        renderBusinessesList();
                        
                        // Update judul dan subtitle
                        document.getElementById('listingsTitle').textContent = `Search: "${query}"`;
                        document.getElementById('listingsSubtitle').textContent = 
                            `Found ${results.total} result${results.total !== 1 ? 's' : ''}`;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    displaySearchResults([{
                        type: 'error',
                        icon: '‚ö†Ô∏è',
                        title: 'Search Error',
                        subtitle: 'Please try again later'
                    }]);
                }
            } else {
                hideSearchResults();
            
                // Jika di halaman listings dan ini adalah reset pencarian, kembalikan tampilan asli
                if (currentPage === 'listings' && currentSearchQuery) {
                    currentSearchQuery = null;
                    
                    // Kembalikan filter kategori dan subkategori
                    if (currentCategory !== 'all') {
                        if (currentSubcategory !== 'all') {
                            fetchBusinessesBySubcategory(currentCategory, currentSubcategory)
                                .then(() => renderBusinessesList());
                        } else {
                            fetchBusinessesByCategory(currentCategory)
                                .then(() => renderBusinessesList());
                        }
                    } else {
                        fetchBusinesses().then(() => renderBusinessesList());
                    }
                    
                    // Kembalikan judul asli
                    const catObj = currentCategory !== 'all' 
                        ? categories.find(c => c.id === currentCategory) 
                        : null;
                    
                    document.getElementById('listingsTitle').textContent = 
                        catObj ? catObj.name : 'All Businesses';
                    
                    document.getElementById('listingsSubtitle').textContent = 
                        catObj ? `${filteredBusinesses.length} businesses found` : 'Discover amazing local services';
                }
            }
        }, 300);
    }



        // Format search results for display
        function formatSearchResults(results, query, suggestions = []) {
    // Inisialisasi array hasil yang diformat
    const formattedResults = [];
    
    // Jika tidak ada hasil bisnis dari API
    if (!results || !results.data || results.data.length === 0) {
        // Jika ada saran kata kunci, tampilkan
        if (suggestions && suggestions.length > 0) {
            return suggestions.slice(0, 3).map(suggestion => ({
                type: 'suggestion',
                icon: 'üîç',
                title: suggestion,
                subtitle: 'Search suggestion',
                id: suggestion
            })).concat([{
                type: 'message',
                icon: 'üí°',
                title: 'No exact matches',
                subtitle: 'Try one of these suggestions'
            }]);
        }
        
        // Jika tidak ada hasil sama sekali, tampilkan pesan kosong
        return [{
            type: 'message',
            icon: 'üîç',
            title: 'No results found',
            subtitle: 'Try different keywords'
        }];
    }
      
    // Cari kategori yang cocok dengan query
    const matchingCategories = categories.filter(category => 
        category.name.toLowerCase().includes(query.toLowerCase())
    );
    
    // Tambahkan kategori yang cocok ke hasil
    if (matchingCategories.length > 0) {
        formattedResults.push(...matchingCategories.slice(0, 2).map(category => ({
            type: 'category',
            id: category.id,
            icon: category.icon || 'üìÅ',
            title: category.name,
            subtitle: `${category.count || 0} businesses`,
            matchText: highlightMatch(category.name, query)
        })));
    }
    
    // Tambahkan saran pencarian jika ada
    if (suggestions && suggestions.length > 0) {
        formattedResults.push(...suggestions.slice(0, 2).map(suggestion => ({
            type: 'suggestion',
            icon: 'üîç',
            title: suggestion,
            subtitle: 'Search suggestion',
            id: suggestion
        })));
    }
     // Tambahkan hasil bisnis
     results.data.forEach(business => {
        // Temukan kategori dan subkategori
        const category = categories.find(c => c.id === business.categoryId);
        const categoryName = category ? category.name : 'Business';
        
        let subcategoryName = '';
        if (category && business.subcategoryId && category.subcategories) {
            const subcategory = category.subcategories.find(s => {
                if (typeof s === 'object') return s.id === business.subcategoryId;
                return s === business.subcategoryId;
            });
            
            if (subcategory) {
                subcategoryName = typeof subcategory === 'object' ? subcategory.name : subcategory;
            }
        }
        
        formattedResults.push({
            type: 'business',
            id: business.id,
            icon: 'üè¢',
            title: business.name,
            subtitle: `${categoryName}${subcategoryName ? ' ‚Ä¢ ' + subcategoryName : ''} ‚Ä¢ ${business.rating || '0.0'}‚≠ê`,
            matchText: highlightMatch(business.name, query),
            categoryId: business.categoryId
        });
    });
        // Jika ada total hasil lebih dari yang ditampilkan
        if (results.total > results.data.length) {
        formattedResults.push({
            type: 'more',
            icon: '‚ûï',
            title: 'See all results',
            subtitle: `${results.total} businesses found`,
            query: query
        });
    }
    
    return formattedResults;
}




    
        // Perform search with API results
        function performSearch(query, results) {
            if (!results || results.length === 0) {
                displaySearchResults([]);
                return;
            }
            
            // Format results for display
            const formattedResults = results.map(result => {
                if (result.type === 'category') {
                    return {
                        type: 'category',
                        id: result.id,
                        title: result.name,
                        subtitle: `${result.count} businesses`,
                        icon: result.icon,
                        matchText: highlightMatch(result.name, query)
                    };
                } else if (result.type === 'subcategory') {
                    return {
                        type: 'subcategory',
                        id: result.id,
                        categoryId: result.categoryId,
                        title: result.name,
                        subtitle: `in ${result.categoryName}`,
                        icon: result.icon,
                        matchText: highlightMatch(result.name, query)
                    };
                } else if (result.type === 'business') {
                    return {
                        type: 'business',
                        id: result.id,
                        title: result.name,
                        subtitle: `${result.categoryDisplay} ‚Ä¢ ${result.rating}‚≠ê`,
                        icon: 'üè¢',
                        matchText: highlightMatch(result.name, query)
                    };
                }
                return result;
            });
            
            displaySearchResults(formattedResults);
        }
    
        // Handle search focus
        function handleSearchFocus() {
            const query = searchInput.value.trim();
            if (query.length > 0) {
                searchBusinesses(query).then(results => {
                    performSearch(query, results);
                }).catch(error => {
                    console.error('Search error:', error);
                });
            }
        }
    
        // Handle search blur
        function handleSearchBlur() {
            // Delay hiding to allow click on search results
            setTimeout(() => {
                hideSearchResults();
            }, 200);
        }
    
        // Display search results
        function displaySearchResults(results) {
    if (!results || results.length === 0) {
        searchResults.innerHTML = `
            <div class="search-result-item">
                <div class="search-result-icon">üîç</div>
                <div class="search-result-info">
                    <div class="search-result-meta">No results found</div>
                </div>
            </div>
        `;
    } else {
        searchResults.innerHTML = results.map(result => {
            // Different rendering based on result type
            if (result.type === 'message' || result.type === 'error') {
                return `
                    <div class="search-result-item search-message">
                        <div class="search-result-icon">${result.icon || 'üîç'}</div>
                        <div class="search-result-info">
                            <h4>${result.title || 'Message'}</h4>
                            <div class="search-result-meta">${result.subtitle || ''}</div>
                        </div>
                    </div>
                `;
            } else if (result.type === 'more') {
                return `
                    <div class="search-result-item search-more" onclick="handleSeeAllResults('${result.query}')">
                        <div class="search-result-icon">${result.icon || '‚ûï'}</div>
                        <div class="search-result-info">
                            <h4>${result.title || 'See all'}</h4>
                            <div class="search-result-meta">${result.subtitle || ''}</div>
                        </div>
                    </div>
                `;
            } else if (result.type === 'suggestion') {
                return `
                    <div class="search-result-item" onclick="handleSearchSuggestion('${result.title}')">
                        <div class="search-result-icon">${result.icon || 'üîç'}</div>
                        <div class="search-result-info">
                            <h4>${result.title || 'Suggestion'}</h4>
                            <div class="search-result-meta">${result.subtitle || ''}</div>
                        </div>
                    </div>
                `;
                } else {
                    // Default for business results
                    return `
                        <div class="search-result-item" onclick="handleSearchResultClick('${result.type}', '${result.id}')">
                            <div class="search-result-icon">${result.icon || 'üîç'}</div>
                            <div class="search-result-info">
                                <h4>${result.matchText || result.title || 'Result'}</h4>
                                <div class="search-result-meta">${result.subtitle || ''}</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }
        
        searchResults.style.display = 'block';
    }

    // Handle melihat semua hasil pencarian
        function handleSeeAllResults(query) {
            // Sembunyikan hasil pencarian
            hideSearchResults();
            
            // Pergi ke halaman listings
            showPage('listings', 'all');
            
            // Atur nilai input pencarian
            searchInput.value = query;
            
            // Trigger pencarian untuk listings
            handleSearchInput();
        }

        // Handle klik pada saran pencarian
        function handleSearchSuggestion(suggestion) {
            // Isi input pencarian dengan saran
            searchInput.value = suggestion;
            
            // Trigger pencarian
            handleSearchInput();
        }

        // Style tambahan untuk fitur pencarian
        const searchStyle = document.createElement('style');
        searchStyle.textContent = `
            .search-result-item {
                padding: 12px 15px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                border-bottom: 1px solid var(--border);
            }
            
            .search-result-item:hover {
                background-color: var(--bg-hover);
            }
            
            .search-result-icon {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                color: var(--text-secondary);
            }
            
            .search-result-info {
                flex: 1;
            }
            
            
            .search-result-info h4 {
                margin: 0 0 4px 0;
                font-size: 14px;
                color: var(--text-primary);
            }
            
            .search-result-meta {
                font-size: 12px;
                color: var(--text-secondary);
            }
            
            .search-highlight {
                background-color: rgba(var(--primary-rgb), 0.2);
                padding: 0 2px;
                border-radius: 2px;
                font-weight: 500;
            }
            
            .search-message {
                background-color: var(--bg-secondary);
                cursor: default;
            }
            
            .search-more {
                background-color: var(--bg-accent);
                font-weight: 500;
            }
            
            .loading-small {
                width: 16px;
                height: 16px;
                border: 2px solid rgba(var(--primary-rgb), 0.2);
                border-top: 2px solid var(--primary);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(searchStyle);

            
                // Highlight search matches
                function highlightMatch(text, query) {
                    if (!text || !query) return text;
                    const regex = new RegExp(`(${query})`, 'gi');
                    return text.replace(regex, '<span class="search-highlight">$1</span>');
                }
            
                // Hide search results
                function hideSearchResults() {
                    searchResults.style.display = 'none';
                }
            
                // Clear search
                function clearSearch() {
                    searchInput.value = '';
                    searchClear.style.display = 'none';
                    hideSearchResults();
                    
                    if (currentPage === 'listings') {
                        renderListings();
                    }
                }
            
            
            function handleSearchResultClick(type, id, additionalData = '') {
            hideSearchResults();
            
            if (type === 'business') {
                openModal(id);
            } else if (type === 'category') {
                showPage('listings', id);
                
                // Update UI untuk menunjukkan kategori yang dipilih
                const category = categories.find(c => c.id === id);
                if (category) {
                    document.getElementById('listingsTitle').textContent = category.name;
                    document.getElementById('listingsSubtitle').textContent = `${category.count || 0} businesses`;
                }
            }
        }

        // Style tambahan untuk hasil kategori dalam pencarian
        const categoriesSearchStyle = document.createElement('style');
        categoriesSearchStyle.textContent = `
            .search-categories-section {
                margin-bottom: 24px;
                padding: 0 16px;
            }
            
            .section-title {
                font-size: 18px;
                margin-bottom: 16px;
                color: var(--text-primary);
            }
            
            .category-cards {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 16px;
            }
            
            .category-card.compact {
                padding: 16px;
                height: auto;
                min-height: 120px;
            }
            
            .category-card.compact .category-icon {
                font-size: 24px;
                margin-bottom: 12px;
            }
            
            .category-card.compact .category-name {
                font-size: 14px;
            }
            
            .category-card.compact .category-count {
                font-size: 12px;
            }
        `;
        document.head.appendChild(categoriesSearchStyle);
        
        // Show page
        function showPage(page, category = null) {
        // Update navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        document.querySelectorAll('.page').forEach(p => {
            p.classList.remove('active');
        });
        
        // Show selected page
        document.getElementById(page + 'Page').classList.add('active');
        
        // Update active nav item
        const navItems = document.querySelectorAll('.nav-item');
        const pageIndex = ['home', 'listings', 'favorites', 'profile'].indexOf(page);
        if (pageIndex >= 0) {
            navItems[pageIndex].classList.add('active');
        }
        
        currentPage = page;
        
        if (page === 'listings') {
            currentCategory = category || 'all';
            currentSubcategory = 'all';
            renderListings();
        } else if (page === 'home') {
            clearSearch();
        } else if (page === 'favorites') {
            // Panggil fetchUserFavorites() saat halaman favorites dibuka
            fetchUserFavorites();
        }
    }

        // Format business hours for display
        function formatBusinessHours(businessHours) {
            if (!businessHours) return "Hours not available";
            
            // Check if hours are in the new format (open/close)
            if (businessHours.open && businessHours.close) {
                return `Daily: ${businessHours.open}-${businessHours.close}`;
            }
            
            // For legacy format (if any)
            return "Hours available on request";
        }
    
            // Render categories
            function renderCategories() {
                const grid = document.getElementById('categoriesGrid');
                
                if (!categories || categories.length === 0) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px; grid-column: span 2;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üìã</div>
                            <p style="margin-bottom: 10px; color: var(--text-primary); font-weight: 600;">No categories available</p>
                            <p style="color: var(--text-secondary);">Check back later for updates</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = categories.map((cat, index) => {
                    // Periksa subcategories - pastikan itu array sebelum menggunakan slice/map
                    let subcategoriesDisplay = 'Various services';
                    if (cat.subcategories && Array.isArray(cat.subcategories) && cat.subcategories.length > 0) {
                        subcategoriesDisplay = cat.subcategories.slice(0, 3).map(sc => {
                            return typeof sc === 'object' ? sc.name : sc;
                        }).join(' ‚Ä¢ ');
                    }
                    
                    return `
                        <div class="category-card" onclick="showPage('listings', '${cat.id}')" 
                            data-aos="fade-up" data-aos-delay="${index * 100}">
                            <span class="category-icon">${cat.icon || 'üìÅ'}</span>
                            <div class="category-name">${cat.name}</div>
                            <div class="category-count">${cat.count || 0} businesses</div>
                            <div class="subcategories">${subcategoriesDisplay}</div>
                        </div>
                    `;
                }).join('');
            }
    
                // Render listings
                async function renderListings() {
                    const title = document.getElementById('listingsTitle');
                    const subtitle = document.getElementById('listingsSubtitle');
                    const filterChips = document.getElementById('filterChips');
                    const subcategoryFilters = document.getElementById('subcategoryFilters');
                    const businessesList = document.getElementById('businessesList');
                    
                    // Show loading
                    businessesList.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: var(--text-secondary);">Loading businesses...</p>
                        </div>
                    `;
                    
                    try {
                        // Render filter chips first
                        filterChips.innerHTML = `
                            <div class="filter-chip ${currentCategory === 'all' ? 'active' : ''}" 
                                onclick="filterByCategory('all')">All</div>
                            ${categories.map(cat => `
                                <div class="filter-chip ${currentCategory === cat.id ? 'active' : ''}" 
                                    onclick="filterByCategory('${cat.id}')">${cat.icon || 'üìÅ'} ${cat.name}</div>
                            `).join('')}
                        `;
                        
                        // If we're filtering by category or subcategory, fetch the filtered data
                        if (currentCategory !== 'all') {
                            if (currentSubcategory !== 'all') {
                                await fetchBusinessesBySubcategory(currentCategory, currentSubcategory);
                            } else {
                                await fetchBusinessesByCategory(currentCategory);
                            }
                            
                            // Render subcategory filters
                            const cat = categories.find(c => c.id === currentCategory);
                            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                                subcategoryFilters.innerHTML = `
                                    <div class="subcategory-chip ${currentSubcategory === 'all' ? 'active' : ''}" 
                                        onclick="filterBySubcategory('all')">All ${cat.name}</div>
                                    ${cat.subcategories.map(sub => `
                                        <div class="subcategory-chip ${currentSubcategory === (sub.id || sub) ? 'active' : ''}" 
                                            onclick="filterBySubcategory('${sub.id || sub}')">${typeof sub === 'object' ? sub.name : sub}</div>
                                    `).join('')}
                                `;
                                subcategoryFilters.style.display = 'flex';
                            } else {
                                subcategoryFilters.style.display = 'none';
                            }
                            
                            // Update title
                            const catObj = categories.find(c => c.id === currentCategory);
                            title.textContent = catObj ? catObj.name : 'Businesses';
                            subtitle.textContent = catObj ? `${filteredBusinesses.length} businesses found` : 'Explore local businesses';
                            
                        } else {
                            // Get all businesses
                            await fetchBusinesses();
                            
                            // Hide subcategory filters
                            subcategoryFilters.style.display = 'none';
                            
                            // Update title
                            title.textContent = 'All Businesses';
                            subtitle.textContent = 'Discover amazing local services';
                        }
                        
                        // Check if we have any businesses to display
                        if (!filteredBusinesses || filteredBusinesses.length === 0) {
                            businessesList.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">üîç</div>
                                    <div class="empty-title">No businesses found</div>
                                    <p>Try adjusting your search or filter</p>
                                </div>
                            `;
                            return;
                        }
                        
                        // Render businesses
                        renderBusinessesList();
                        
                    } catch (error) {
                        console.error('Error rendering listings:', error);
                        businessesList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">‚ö†Ô∏è</div>
                                <div class="empty-title">Error loading businesses</div>
                                <p>Please try again later</p>
                                <button class="action-btn btn-primary" style="margin-top: 15px;" onclick="renderListings()">
                                    <i class="fas fa-redo"></i> Retry
                                </button>
                            </div>
                        `;
                    }
                }
    
        // Filter by category
        async function filterByCategory(categoryId) {
            try {
                showListingsLoading();
                currentCategory = categoryId;
                currentSubcategory = 'all';
                
                // Update UI
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.toggle('active', chip.getAttribute('data-id') === categoryId);
                });
                
                // Fetch data
                if (categoryId === 'all') {
                    await fetchBusinesses();
                } else {
                    await fetchBusinessesByCategory(categoryId);
                }
                
                // Render subcategory filters
                renderSubcategoryFilters();
                
                // Render business list
                renderBusinessesList();
            } catch (error) {
                console.error('Error filtering by category:', error);
                showListingsError('Failed to load businesses. Please try again.');
            }
        }

        // Filter by subcategory
        async function filterBySubcategory(subcategoryId) {
            try {
                showListingsLoading();
                currentSubcategory = subcategoryId;
                
                // Update UI
                document.querySelectorAll('.subcategory-chip').forEach(chip => {
                    chip.classList.toggle('active', chip.getAttribute('data-id') === subcategoryId);
                });
                
                // Fetch data
                if (subcategoryId === 'all') {
                    await fetchBusinessesByCategory(currentCategory);
                } else {
                    await fetchBusinessesBySubcategory(currentCategory, subcategoryId);
                }
                
                // Render business list
                renderBusinessesList();
            } catch (error) {
                console.error('Error filtering by subcategory:', error);
                showListingsError('Failed to load businesses. Please try again.');
            }
        }

    // Render subcategory filters
    function renderSubcategoryFilters() {
        const subcategoryFilters = document.getElementById('subcategoryFilters');
        
        if (currentCategory === 'all') {
            subcategoryFilters.style.display = 'none';
            return;
        }
        
        const category = categories.find(c => c.id === currentCategory);
        if (!category || !category.subcategories || category.subcategories.length === 0) {
            subcategoryFilters.style.display = 'none';
            return;
        }
        
        subcategoryFilters.innerHTML = `
            <div class="subcategory-chip active" data-id="all" onclick="filterBySubcategory('all')">
                All ${category.name}
            </div>
            ${category.subcategories.map(subcategory => `
                <div class="subcategory-chip" data-id="${subcategory.id}" 
                    onclick="filterBySubcategory('${subcategory.id}')">
                    ${subcategory.name}
                </div>
            `).join('')}
        `;
        
        subcategoryFilters.style.display = 'flex';
    }
    
        // Get subcategory name
        function getSubcategoryName(categoryId, subcategoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (category && category.subcategories) {
                const subcategory = category.subcategories.find(s => s.id === subcategoryId);
                return subcategory ? subcategory.name : 'General';
            }
            return 'General';
        }
    
        async function openModal(businessId) {
        try {
            // Show loading in modal
            document.getElementById('modalDetails').innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div class="loading"></div>
                    <p style="margin-top: 15px; color: var(--text-secondary);">Loading details...</p>
                </div>
            `;
            
            document.getElementById('businessModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Fetch business details
            const business = await fetchBusinessDetail(businessId);
            
            if (!business || Object.keys(business).length === 0) {
                throw new Error('Business not found');
            }
            
            // Cek status favorit
            const favoriteStatus = await checkFavoriteStatus([businessId]);
            const isFavorite = favoriteStatus[businessId] || false;
            
            // Use the first image if available, otherwise use placeholder
            const imageUrl = business.images && business.images.length > 0 
                ? business.images[0] 
                : '/api/placeholder/300/160';
                
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('modalTitle').textContent = business.name;
            
            // Find category name
            const category = categories.find(c => c.id === business.categoryId);
            const categoryName = category ? category.name : 'General';
            document.getElementById('modalCategory').textContent = categoryName;
            
            // Format business hours
            const hours = formatBusinessHours(business.businessHours);
            
            document.getElementById('modalDetails').innerHTML = `
                <div class="business-detail">
                    <i class="fas fa-tag"></i>
                    ${business.subcategoryId ? getSubcategoryName(business.categoryId, business.subcategoryId) : 'General'}
                </div>
                <div class="business-detail">
                    <i class="fas fa-map-marker-alt"></i>
                    ${business.address || 'Address not available'}
                </div>
                <div class="business-detail">
                    <i class="fas fa-phone"></i>
                    ${business.phone || 'Phone not available'}
                </div>
                <div class="business-detail">
                    <div class="business-rating">
                        <i class="fas fa-star"></i>
                        <span>${business.rating || '0.0'} (${business.reviewCount || '0'} reviews)</span>
                    </div>
                </div>
                <div class="business-detail">
                    <i class="fas fa-clock"></i>
                    ${hours}
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="color: var(--text-secondary); line-height: 1.6;">${business.description || 'No description available'}</p>
                </div>
                ${business.keywords && business.keywords.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Keywords:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${business.keywords.map(keyword => `
                                <span style="background: var(--bg-secondary); color: var(--text-secondary); 
                                            padding: 4px 8px; border-radius: 8px; font-size: 12px;">${keyword}</span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                ${business.email ? `
                    <div class="business-detail" style="margin-top: 15px;">
                        <i class="fas fa-envelope"></i>
                        ${business.email}
                    </div>
                ` : ''}
                ${business.website ? `
                    <div class="business-detail">
                        <i class="fas fa-globe"></i>
                        <a href="${business.website}" target="_blank" style="color: var(--primary);">${business.website}</a>
                    </div>
                ` : ''}
            `;

            // Setup action buttons
            document.getElementById('callBtn').onclick = () => {
                window.location.href = `tel:${business.phone}`;
            };
            
            document.getElementById('directionBtn').onclick = () => {
                if (business.latitude && business.longitude) {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${business.latitude},${business.longitude}`, '_blank');
                } else {
                    openDirections(business.address);
                }
            };
            
            // Tambahkan tombol favorit di modal
            const favoriteBtn = document.createElement('button');
            favoriteBtn.className = `action-btn ${isFavorite ? 'btn-danger' : 'btn-secondary'}`;
            favoriteBtn.innerHTML = `
                <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i> ${isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}
            `;
            favoriteBtn.onclick = () => {
                if (isFavorite) {
                    removeFromFavorites(businessId);
                    favoriteBtn.className = 'action-btn btn-secondary';
                    favoriteBtn.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
                } else {
                    addToFavorites(businessId);
                    favoriteBtn.className = 'action-btn btn-danger';
                    favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
                }
            };
            
            // Tambahkan tombol ke modal-actions
            const modalActions = document.querySelector('.modal-actions');
            if (modalActions) {
                // Hapus tombol favorit yang mungkin sudah ada
                const existingFavBtn = modalActions.querySelector('.favorite-btn');
                if (existingFavBtn) {
                    existingFavBtn.remove();
                }
                
                // Tambahkan tombol favorit yang baru
                const newFavBtn = document.createElement('button');
                newFavBtn.className = `action-btn ${isFavorite ? 'btn-danger' : 'btn-secondary'} favorite-btn`;
                newFavBtn.innerHTML = `
                    <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i> ${isFavorite ? 'Unfavorite' : 'Favorite'}
                `;
                newFavBtn.onclick = () => {
                    if (isFavorite) {
                        removeFromFavorites(businessId);
                        newFavBtn.className = 'action-btn btn-secondary favorite-btn';
                        newFavBtn.innerHTML = '<i class="far fa-heart"></i> Favorite';
                    } else {
                        addToFavorites(businessId);
                        newFavBtn.className = 'action-btn btn-danger favorite-btn';
                        newFavBtn.innerHTML = '<i class="fas fa-heart"></i> Unfavorite';
                    }
                };
                
                modalActions.appendChild(newFavBtn);
            }
        } catch (error) {
            console.error('Error opening modal:', error);
            document.getElementById('modalDetails').innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                    <p style="margin-bottom: 20px; color: var(--text-primary); font-weight: 600;">Failed to load details</p>
                    <button class="action-btn btn-primary" style="display: inline-block;" onclick="openModal(${businessId})">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }
      
        // Close modal
        function closeModal() {
            document.getElementById('businessModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    
        // Open directions
        function openDirections(address) {
            const encodedAddress = encodeURIComponent(address);
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
        }
    
        // Show listings loading state
        function showListingsLoading() {
            document.getElementById('businessesList').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading"></div>
                    <p style="margin-top: 10px; color: var(--text-secondary);">Loading businesses...</p>
                </div>
            `;
        }
        
        // Show listings error
        function showListingsError(message) {
            document.getElementById('businessesList').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                    <p style="margin-bottom: 20px; color: var(--text-primary); font-weight: 600;">${message}</p>
                    <button class="action-btn btn-primary" style="display: inline-block;" onclick="renderListings()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }

        // Render businesses in the listings page
        async function renderBusinessesList() {
            const businessesList = document.getElementById('businessesList');
            
            if (!filteredBusinesses || filteredBusinesses.length === 0) {
                businessesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">No businesses found</div>
                        <p>Try adjusting your search or filter</p>
                    </div>
                `;
                return;
            }
            
            // Dapatkan IDs semua bisnis
            const businessIds = filteredBusinesses.map(business => business.id);
            
            // Cek status favorit
            const favoriteStatus = await checkFavoriteStatus(businessIds);
            
            businessesList.innerHTML = filteredBusinesses.map((business, index) => {
                // Get image URL - handle array or string
                let imageUrl = '/api/placeholder/300/160';
                if (business.images) {
                    if (Array.isArray(business.images) && business.images.length > 0) {
                        imageUrl = business.images[0];
                    } else if (typeof business.images === 'string') {
                        imageUrl = business.images;
                    }
                }
                
                // Get category name
                let categoryName = 'General';
                let subcategoryName = 'General';
                
                const category = categories.find(c => c.id === business.categoryId);
                if (category) {
                    categoryName = category.name;
                    
                    // Get subcategory name if available
                    if (business.subcategoryId && category.subcategories) {
                        const subcategory = category.subcategories.find(s => 
                            s.id === business.subcategoryId || 
                            (typeof s === 'string' && s === business.subcategoryId)
                        );
                        
                        if (subcategory) {
                            subcategoryName = typeof subcategory === 'object' ? subcategory.name : subcategory;
                        }
                    }
                }
                
                // Periksa apakah bisnis ini sudah difavoritkan
                const isFavorite = favoriteStatus[business.id] || false;
                const heartClass = isFavorite ? 'active' : '';
                const heartIcon = isFavorite ? 'fas fa-heart' : 'far fa-heart';
                const heartAction = isFavorite 
                    ? `removeFromFavorites('${business.id}', event)` 
                    : `addToFavorites('${business.id}', event)`;
                
                return `
                    <div class="business-card" onclick="openModal('${business.id}')" 
                        data-aos="fade-up" data-aos-delay="${index * 100}">
                        <div class="heart-icon ${heartClass}" data-id="${business.id}" onclick="${heartAction}">
                            <i class="${heartIcon}"></i>
                        </div>
                        <img src="${imageUrl}" alt="${business.name}" class="business-image">
                        <div class="business-content">
                            <div class="business-header">
                                <div class="business-info">
                                    <h3>${business.name}</h3>
                                    <div class="business-category">${categoryName}</div>
                                    <div class="business-subcategory">${subcategoryName}</div>
                                </div>
                                <div class="business-rating">
                                    <span class="rating-stars">‚≠ê</span>
                                    <span>${business.rating || '0.0'}</span>
                                </div>
                            </div>
                            <div class="business-details">
                                <div class="business-detail">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${business.address || 'Address not available'}
                                </div>
                                <div class="business-detail">
                                    <i class="fas fa-phone"></i>
                                    ${business.phone || 'Phone not available'}
                                </div>
                                <div class="business-detail">
                                    <i class="fas fa-star"></i>
                                    ${business.rating || '0.0'} (${business.reviewCount || '0'} reviews)
                                </div>
                            </div>
                            <div class="business-actions">
                                <button class="action-btn btn-primary" onclick="event.stopPropagation(); window.location.href='tel:${business.phone}'">
                                    <i class="fas fa-phone"></i> Call
                                </button>
                                <button class="action-btn btn-secondary" onclick="event.stopPropagation(); openDirections('${encodeURIComponent(business.address || '')}')">
                                    <i class="fas fa-map-marker-alt"></i> Directions
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Re-initialize AOS for new elements
            setTimeout(() => AOS.refresh(), 100);
        }

        // Format business hours for display
        function formatBusinessHours(businessHours) {
            if (!businessHours) return "Hours not available";
            
            // Check if hours are in the new format (open/close)
            if (businessHours.open && businessHours.close) {
                return `Daily: ${businessHours.open}-${businessHours.close}`;
            }
            
            // For legacy format (if any)
            return "Hours available on request";
        }

        // Get subcategory name from id
        function getSubcategoryName(categoryId, subcategoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category || !category.subcategories) return 'General';
            
            const subcategory = category.subcategories.find(s => s.id === subcategoryId);
            return subcategory ? subcategory.name : 'General';
        }


        // Tambahkan kode ini di akhir bagian <script>

        // Admin state
        let adminPageNumber = 1;
        let adminPageSize = 10;
        let adminTotalPages = 1;
        let adminCurrentTab = 'add-listing';
        let uploadedImages = [];

        // Modify the floating add button to show admin login modal
        document.querySelector('.floating-add').onclick = function() {
            if (isAdminLoggedIn()) {
                openAdminModal();
            } else {
                openAdminLoginModal();
            }
        };

        // Check if admin is logged in
        function isAdminLoggedIn() {
            return localStorage.getItem('adminToken') !== null;
        }

        // Open admin login modal
        function openAdminLoginModal() {
            document.getElementById('adminLoginModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Close admin login modal
        function closeAdminLoginModal() {
            document.getElementById('adminLoginModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Handle admin login
        async function handleAdminLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorElement = document.getElementById('adminLoginError');
            
            // Simple validation
            if (!username || !password) {
                errorElement.textContent = 'Please enter both username and password';
                errorElement.style.display = 'block';
                return;
            }
            
            try {
                // Show loading
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
                submitBtn.disabled = true;
                
                console.log('Sending admin login request:', { username, password });
                
                // Call API to login
                const response = await fetch(`${API_BASE_URL}/auth/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Login error response:', response.status, errorText);
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.message || 'Invalid credentials 2');
                    } catch (e) {
                        throw new Error(`Login failed: ${response.status} ${response.statusText}`);
                    }
                }
                
                const data = await response.json();
                console.log('Login success:', data);
                
                // Store token
                localStorage.setItem('adminToken', data.token);
                localStorage.setItem('adminUser', JSON.stringify(data.user));
                
                // Close login modal and open admin panel
                // closeAdminLoginModal();
                // openAdminModal();

                updateUserInterface(false, true);
                
                // Show home page after login
                showPage('home');
                
                // Show success toast
                showToast('Login successful', 'success');
                
                // Show success toast
                showToast('Login successful', 'success');
                
            } catch (error) {
                // Show error
                errorElement.textContent = error.message || 'Login failed';
                errorElement.style.display = 'block';
                console.error('Admin login error:', error);
            } finally {
                // Restore button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }





        const adminModalStyle = document.createElement('style');
        adminModalStyle.id = 'admin-modal-style';
        adminModalStyle.textContent = `
            .admin-modal-content {
                max-width: 800px;
                margin: 0 auto;
                position: relative;
                height: auto;
                max-height: 90vh;
                padding: 30px;
                border-radius: 16px;
                box-shadow: var(--shadow-lg);
            }
            
            .admin-tabs {
                display: flex;
                border-bottom: 1px solid var(--border);
                margin-bottom: 25px;
                gap: 10px;
                overflow-x: auto;
                scrollbar-width: none;
                padding-bottom: 10px;
            }
            
            .admin-tabs::-webkit-scrollbar {
                display: none;
            }
            
            .admin-tab {
                padding: 12px 20px;
                cursor: pointer;
                font-weight: 600;
                color: var(--text-secondary);
                border-radius: 8px;
                transition: all 0.3s ease;
                white-space: nowrap;
            }
            
            .admin-tab.active {
                background: var(--primary);
                color: white;
            }
            
            .admin-tab:hover:not(.active) {
                background: var(--bg-secondary);
                color: var(--text-primary);
            }
            
            .admin-tab-content {
                display: none;
                animation: fadeIn 0.3s ease;
            }
            
            .admin-tab-content.active {
                display: block;
            }
            
            .admin-form {
                background: var(--bg-secondary);
                padding: 25px;
                border-radius: 12px;
                margin-bottom: 25px;
            }
            
            .form-row {
                margin-bottom: 20px;
            }
            
            .form-row label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: var(--text-primary);
            }
            
            .form-row input, .form-row select, .form-row textarea {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid var(--border);
                border-radius: 8px;
                font-size: 15px;
                transition: all 0.3s ease;
                background: white;
            }
            
            .form-row input:focus, .form-row select:focus, .form-row textarea:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
                outline: none;
            }
            
            .form-row textarea {
                min-height: 120px;
                resize: vertical;
            }
            
            .form-row.two-col {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .checkbox-label {
                display: flex;
                align-items: center;
                cursor: pointer;
            }
            
            .checkbox-label input {
                width: auto;
                margin-right: 10px;
            }
            
            .form-actions {
                display: flex;
                justify-content: flex-end;
                gap: 15px;
                margin-top: 30px;
            }
            
            .admin-action-btn {
                padding: 8px 12px;
                border-radius: 6px;
                border: none;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
            }
            
            .admin-action-btn.btn-edit {
                background: rgba(99, 102, 241, 0.1);
                color: var(--primary);
            }
            
            .admin-action-btn.btn-delete {
                background: rgba(239, 68, 68, 0.1);
                color: var(--danger);
            }
            
            .admin-action-btn:hover {
                opacity: 0.8;
            }
            
            .admin-search {
                display: flex;
                margin-bottom: 20px;
            }
            
            .admin-search input {
                flex: 1;
                padding: 12px 15px;
                border: 1px solid var(--border);
                border-radius: 8px 0 0 8px;
                font-size: 15px;
            }
            
            .admin-search-btn {
                padding: 0 15px;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 0 8px 8px 0;
                cursor: pointer;
            }
            
            .admin-table-container {
                overflow-x: auto;
                margin-bottom: 20px;
                background: white;
                border-radius: 12px;
                box-shadow: var(--shadow);
            }
            
            .admin-table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .admin-table th, .admin-table td {
                padding: 15px;
                text-align: left;
                border-bottom: 1px solid var(--border);
            }
            
            .admin-table th {
                background: var(--bg-secondary);
                font-weight: 600;
                position: sticky;
                top: 0;
                z-index: 1;
            }
            
            .admin-table tr:hover {
                background: rgba(99, 102, 241, 0.05);
            }
            
            .admin-pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 15px;
            }
            
            .pagination-btn {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: 1px solid var(--border);
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .pagination-btn:hover {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }
            
            .image-upload-container {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .image-upload-box {
                width: 120px;
                height: 120px;
                border: 2px dashed var(--border);
                border-radius: 12px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
                background: white;
            }
            
            .image-upload-box:hover {
                border-color: var(--primary);
                background: rgba(99, 102, 241, 0.05);
            }
            
            .image-upload-box i {
                font-size: 28px;
                color: var(--primary);
                margin-bottom: 10px;
            }
            
            .image-upload-box p {
                font-size: 12px;
                color: var(--text-secondary);
            }
            
            .image-preview {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .preview-item {
                position: relative;
                width: 120px;
                height: 120px;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: var(--shadow);
            }
            
            .preview-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .remove-image {
                position: absolute;
                top: 5px;
                right: 5px;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .remove-image:hover {
                background: white;
                transform: scale(1.1);
            }
            
            .admin-category-actions {
                display: flex;
                justify-content: flex-end;
                margin-bottom: 20px;
            }
            
            /* Toast Notifications */
            .toast {
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: white;
                border-radius: 12px;
                padding: 15px 20px;
                display: flex;
                align-items: center;
                gap: 15px;
                box-shadow: var(--shadow-lg);
                transform: translateY(100px);
                opacity: 0;
                transition: all 0.3s ease;
                z-index: 1000;
                max-width: 350px;
            }
            
            .toast.show {
                transform: translateY(0);
                opacity: 1;
            }
            
            .toast-icon {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            
            .toast-icon.success {
                background: rgba(16, 185, 129, 0.1);
                color: #10b981;
            }
            
            .toast-icon.error {
                background: rgba(239, 68, 68, 0.1);
                color: var(--danger);
            }
            
            .toast-message {
                flex: 1;
                font-size: 14px;
                color: var(--text-primary);
            }
            
            .toast-close {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                background: var(--bg-secondary);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                flex-shrink: 0;
            }
            
            .toast-close:hover {
                background: var(--border);
            }
            
            @media (max-width: 768px) {
                .admin-modal-content {
                    width: 100%;
                    border-radius: 16px 16px 0 0;
                    padding: 20px;
                }
                
                .form-row.two-col {
                    grid-template-columns: 1fr;
                }
                
                .admin-tabs {
                    padding-bottom: 5px;
                }
                
                .admin-tab {
                    padding: 10px 15px;
                    font-size: 14px;
                }
            }
        `;

        document.head.appendChild(adminModalStyle);


        // Open admin modal
        function openAdminModal() {
        // Reset admin UI
        adminCurrentTab = 'add-listing';
        
        // Populate categories dropdown
        populateCategoriesDropdown();
        
        // Show admin modal
        const adminModal = document.getElementById('adminModal');
        adminModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Efek fade in untuk modal
        setTimeout(() => {
            adminModal.querySelector('.modal-content').style.transform = 'translateY(0)';
            adminModal.querySelector('.modal-content').style.opacity = '1';
        }, 10);
        
        // Set active tab
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.classList.toggle('active', tab.getAttribute('data-tab') === adminCurrentTab);
        });
        
        document.querySelectorAll('.admin-tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `${adminCurrentTab}-content`);
        });
        
        // Load admin data based on current tab
        loadAdminTabContent(adminCurrentTab);
    }

        // Close admin modal
        function closeAdminModal() {
        const adminModal = document.getElementById('adminModal');
        const modalContent = adminModal.querySelector('.modal-content');
        
        // Efek fade out
        modalContent.style.transform = 'translateY(20px)';
        modalContent.style.opacity = '0';
        
        // Tunggu animasi selesai baru hide modal
        setTimeout(() => {
            adminModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('addListingForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            uploadedImages = [];
        }, 300);
    }

        // Load admin tab content
        function loadAdminTabContent(tab) {
            switch(tab) {
                case 'add-listing':
                    // Nothing to load here, form is static
                    break;
                case 'manage-listings':
                    loadBusinessesForAdmin();
                    break;
                case 'categories':
                    loadCategoriesForAdmin();
                    break;
                case 'manage-subcategories':
                    initSubcategoriesTab();
                    break;
            }
        }

        // Load businesses for admin
        async function loadBusinessesForAdmin() {
            try {
                const adminBusinessList = document.getElementById('adminBusinessList');
                adminBusinessList.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 20px;">
                            <div class="loading" style="display: inline-block;"></div>
                            <p style="margin-top: 10px;">Loading businesses...</p>
                        </td>
                    </tr>
                `;
                
                // Try using the regular businesses endpoint instead of admin-specific
                const response = await fetch(`${API_BASE_URL}/businesses?limit=${adminPageSize}&offset=${(adminPageNumber-1)*adminPageSize}&sortBy=createdAt&sortOrder=DESC`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    console.error(`API Error: ${response.status} ${response.statusText}`);
                    const errorText = await response.text();
                    console.error(`Response body: ${errorText}`);
                    throw new Error(`Failed to load businesses: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Update pagination
                adminTotalPages = Math.ceil(data.total / adminPageSize);
                document.getElementById('currentPage').textContent = `Page ${adminPageNumber} of ${adminTotalPages}`;
                
                if (!data.data || data.data.length === 0) {
                    adminBusinessList.innerHTML = `
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 20px;">
                                No businesses found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Render businesses
                adminBusinessList.innerHTML = data.data.map(business => {
                    // Find category
                    const category = categories.find(c => c.id === business.categoryId);
                    const categoryName = category ? category.name : 'General';
                    
                    return `
                        <tr>
                            <td>${business.name}</td>
                            <td>${categoryName}</td>
                            <td>
                                <button class="admin-action-btn btn-edit" onclick="editBusiness('${business.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="admin-action-btn btn-delete" onclick="deleteBusiness('${business.id}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading businesses for admin:', error);
                document.getElementById('adminBusinessList').innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 20px; color: var(--danger);">
                            Error loading businesses: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Load categories for admin
        async function loadCategoriesForAdmin() {
            try {
                // Menampilkan loading spinner
                document.getElementById('adminCategoryList').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px;">
                            <div class="loading" style="display: inline-block;"></div>
                            <p style="margin-top: 10px;">Loading categories...</p>
                        </td>
                    </tr>
                `;
                
                // Tampilkan kategori dari variabel global
                const adminCategoryList = document.getElementById('adminCategoryList');
                adminCategoryList.innerHTML = categories.map(category => {
                    return `
                        <tr>
                            <td>${category.icon}</td>
                            <td>${category.name}</td>
                            <td>${category.subcategories ? category.subcategories.length : 0} Subcategories <td>
                                <button class="admin-action-btn btn-edit" onclick="editCategory('${category.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="admin-action-btn btn-delete" onclick="deleteCategory('${category.id}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading categories for admin:', error);
                document.getElementById('adminCategoryList').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: var(--danger);">
                            Error loading categories: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }


        // Switch admin tab
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('admin-tab')) {
                const tab = e.target.getAttribute('data-tab');
                adminCurrentTab = tab;
                
                // Update active tab
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                e.target.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tab}-content`).classList.add('active');
                
                // Load content for the tab
                loadAdminTabContent(tab);
            }
        });

        // Populate categories dropdown
        function populateCategoriesDropdown() {
            const categorySelect = document.getElementById('businessCategory');
            
            // Clear existing options except the first one
            while (categorySelect.options.length > 1) {
                categorySelect.remove(1);
            }
            
            // Add options for each category
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        // Load subcategories based on selected category
        function loadSubcategories() {
            const categoryId = document.getElementById('businessCategory').value;
            const subcategorySelect = document.getElementById('businessSubcategory');
            
            // Clear existing options except the first one
            while (subcategorySelect.options.length > 1) {
                subcategorySelect.remove(1);
            }
            
            if (!categoryId) {
                return;
            }
            
            // Find selected category
            const category = categories.find(c => c.id === categoryId);
            if (!category || !category.subcategories || category.subcategories.length === 0) {
                return;
            }
            
            // Add options for each subcategory
            category.subcategories.forEach(subcategory => {
                const option = document.createElement('option');
                option.value = typeof subcategory === 'object' ? subcategory.id : subcategory;
                option.textContent = typeof subcategory === 'object' ? subcategory.name : subcategory;
                subcategorySelect.appendChild(option);
            });
        }

        // Preview uploaded image
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Create preview with animation
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.style.opacity = '0';
                    previewItem.style.transform = 'scale(0.9)';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="remove-image" onclick="removePreview()">
                            <i class="fas fa-times"></i>
                        </div>
                    `;
                    
                    preview.innerHTML = '';
                    preview.appendChild(previewItem);
                    
                    // Animate in
                    setTimeout(() => {
                        previewItem.style.opacity = '1';
                        previewItem.style.transform = 'scale(1)';
                    }, 10);
                    
                    // Store the file for later upload
                    uploadedImages = [file];
                };
                
                reader.readAsDataURL(file);
            }
        }
        // Remove preview image
        function removePreview() {
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('businessImage').value = '';
            uploadedImages = [];
        }

        // Show Add Category form
        function showAddCategoryForm() {
        const formContainer = document.getElementById('categoryFormContainer');
        
        // Reset form
        document.getElementById('addCategoryForm').reset();
        
        // Tampilkan dengan animasi
        formContainer.style.opacity = '0';
        formContainer.style.transform = 'translateY(-20px)';
        formContainer.style.display = 'block';
        
        setTimeout(() => {
            formContainer.style.opacity = '1';
            formContainer.style.transform = 'translateY(0)';
        }, 10);
    }

        // Hide Add Category form
        function hideAddCategoryForm() {
        const formContainer = document.getElementById('categoryFormContainer');
        
        // Sembunyikan dengan animasi
        formContainer.style.opacity = '0';
        formContainer.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            formContainer.style.display = 'none';
            document.getElementById('addCategoryForm').reset();
        }, 300);
    }

  
    // Add event listener for adding/updating business
        document.getElementById('addListingForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        try {
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
            submitBtn.disabled = true;
            
            // Konversi form data langsung ke JSON
            const formElements = event.target.elements;
            const jsonData = {};
            
            // Ambil semua field kecuali upload gambar
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                
                // Skip buttons dan file inputs
                if (element.type !== 'button' && 
                    element.type !== 'submit' && 
                    element.type !== 'file' && 
                    element.name) {
                    
                    // Handle checkbox
                    if (element.type === 'checkbox') {
                        jsonData[element.name] = element.checked;
                    } 
                    // Handle radio buttons
                    else if (element.type === 'radio') {
                        if (element.checked) {
                            jsonData[element.name] = element.value;
                        }
                    } 
                    // Handle other field types
                    else if (element.value.trim() !== '') {
                        jsonData[element.name] = element.value;
                    }
                }
            }
            
            // Format data khusus
            if (jsonData.keywords) {
                jsonData.keywords = jsonData.keywords.split(',')
                    .map(keyword => keyword.trim())
                    .filter(keyword => keyword.length > 0);
            }
            
            // Handle business hours
            if (jsonData.openTime && jsonData.closeTime) {
                jsonData.businessHours = {
                    open: jsonData.openTime,
                    close: jsonData.closeTime
                };
                delete jsonData.openTime;
                delete jsonData.closeTime;
            }
            
            // Convert numeric fields
            if (jsonData.latitude) jsonData.latitude = parseFloat(jsonData.latitude);
            if (jsonData.longitude) jsonData.longitude = parseFloat(jsonData.longitude);
            
            // Cek apakah form dalam mode edit
            const isEditMode = event.target.getAttribute('data-edit-mode') === 'true';
            const businessId = event.target.getAttribute('data-business-id');
            
            let response;
            
            console.log('Sending JSON data:', jsonData);
            
            if (isEditMode && businessId) {
                // Mode update - menggunakan PATCH dengan JSON
                response = await fetch(`${API_BASE_URL}/businesses/${businessId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                });
            } else {
                // Mode add - menggunakan POST dengan JSON
                response = await fetch(`${API_BASE_URL}/businesses`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                });
            }
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to save business');
            }
            
            const responseData = await response.json();
            console.log('Response data:', responseData);
            
            // Show success message
            showToast(isEditMode ? 'Business updated successfully' : 'Business created successfully', 'success');
            
            // Reset form
            event.target.reset();
            
            // Reset edit mode
            event.target.removeAttribute('data-edit-mode');
            event.target.removeAttribute('data-business-id');
            
            // Change button text back
            submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Business';
            
            // Close modal and refresh listings
            closeAdminModal();
            if (currentPage === 'listings') {
                renderListings();
            } else {
                fetchBusinesses();
            }
            
        } catch (error) {
            console.error('Error saving business:', error);
            showToast('Error: ' + error.message, 'error');
        } finally {
            // Restore button
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Business';
            submitBtn.disabled = false;
        }
    });
        // Add event listener for adding new category
        document.getElementById('addCategoryForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
                submitBtn.disabled = true;
                
                // Ekstrak data dari form
                const formData = new FormData(event.target);
                const categoryData = {};
                
                // Konversi FormData ke JSON, tetapi hanya ambil field yang diperlukan
                // Jangan termasuk subcategories karena akan menimbulkan error
                for (let [key, value] of formData.entries()) {
                    if (key !== 'subcategories') {
                        categoryData[key] = value;
                    }
                }
                
                // Generate slug dari name jika tidak ada
                if (!categoryData.slug && categoryData.name) {
                    categoryData.slug = categoryData.name
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-') // Ganti karakter non-alfanumerik dengan -
                        .replace(/^-|-$/g, '') // Hapus - di awal dan akhir
                        .substring(0, 100); // Batasi panjang slug maksimal 100 karakter
                }
                
                // Pastikan slug tidak melebihi 100 karakter
                if (categoryData.slug && categoryData.slug.length > 100) {
                    categoryData.slug = categoryData.slug.substring(0, 100);
                }
                
                console.log('Sending category data:', categoryData);
                
                // Cek mode edit atau tambah baru
                const categoryId = event.target.getAttribute('data-category-id');
                let response;
                
                if (categoryId) {
                    // Mode edit
                    response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(categoryData)
                    });
                } else {
                    // Mode tambah baru
                    response = await fetch(`${API_BASE_URL}/categories`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(categoryData)
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save category');
                }
                
                // Show success message
                showToast(categoryId ? 'Category updated successfully' : 'Category created successfully', 'success');
                
                // Reset form dan sembuyikan
                event.target.reset();
                event.target.removeAttribute('data-category-id');
                hideAddCategoryForm();
                
                // Refresh data kategori
                await fetchCategories();
                loadCategoriesForAdmin();
                
            } catch (error) {
                console.error('Error saving category:', error);
                showToast('Error: ' + error.message, 'error');
            } finally {
                // Restore button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });

        // Handle admin pagination
        function changePage(direction) {
            const newPage = adminPageNumber + direction;
            if (newPage < 1 || newPage > adminTotalPages) return;
            
            adminPageNumber = newPage;
            loadBusinessesForAdmin();
        }

        // Search businesses in admin
        function searchAdminBusinesses() {
            const query = document.getElementById('adminSearchInput').value.trim();
            // Reset page number when searching
            adminPageNumber = 1;
            loadBusinessesForAdmin(query);
        }

        // Delete business (admin)
        async function deleteBusiness(businessId) {
            if (!confirm('Are you sure you want to delete this business?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/businesses/${businessId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete business');
                }
                
                showToast('Business deleted successfully', 'success');
                
                // Refresh the list
                loadBusinessesForAdmin();
                
                // Refresh main business list if we're on listings page
                if (currentPage === 'listings') {
                    renderListings();
                }
                
            } catch (error) {
                console.error('Error deleting business:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Delete category (admin)
        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category? All businesses in this category will be moved to General.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete category');
                }
                
                showToast('Category deleted successfully', 'success');
                
                // Refresh categories
                await fetchCategories();
                loadCategoriesForAdmin();
                populateCategoriesDropdown();
                
                // Refresh main listings if we're on listings page
                if (currentPage === 'listings') {
                    renderListings();
                }
                
            } catch (error) {
                console.error('Error deleting category:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
    // Remove any existing toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon ${type}">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                </div>
                <div class="toast-message">${message}</div>
                <div class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Show the toast with animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Edit business (admin)
        async function editBusiness(businessId) {
            try {
                // Fetch business details
                const business = await fetchBusinessDetail(businessId);
                
                if (!business) {
                    throw new Error('Business not found');
                }
                
                // Switch to Add Listing tab (we'll reuse it for editing)
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.getAttribute('data-tab') === 'add-listing');
                });
                
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === 'add-listing-content');
                });
                
                // Populate form
                document.getElementById('businessName').value = business.name || '';
                document.getElementById('businessCategory').value = business.categoryId || '';
                
                // Load subcategories and select the right one
                loadSubcategories();
                setTimeout(() => {
                    document.getElementById('businessSubcategory').value = business.subcategoryId || '';
                }, 100);
                
                document.getElementById('businessDescription').value = business.description || '';
                document.getElementById('businessPhone').value = business.phone || '';
                document.getElementById('businessAddress').value = business.address || '';
                document.getElementById('businessLatitude').value = business.latitude || '';
                document.getElementById('businessLongitude').value = business.longitude || '';
                document.getElementById('businessWebsite').value = business.website || '';
                document.getElementById('businessEmail').value = business.email || '';
                
                // Handle keywords
                if (business.keywords && Array.isArray(business.keywords)) {
                    document.getElementById('businessKeywords').value = business.keywords.join(', ');
                }
                
                // Handle business hours
                if (business.businessHours) {
                    if (business.businessHours.open) {
                        document.getElementById('businessOpenTime').value = business.businessHours.open;
                    }
                    if (business.businessHours.close) {
                        document.getElementById('businessCloseTime').value = business.businessHours.close;
                    }
                }
                
                // Handle featured
                if (document.getElementById('businessFeatured')) {
                    document.getElementById('businessFeatured').checked = business.featured || false;
                }
                
                // REMOVED: Image preview handling
                
                // Set form to edit mode
                const form = document.getElementById('addListingForm');
                form.setAttribute('data-edit-mode', 'true');
                form.setAttribute('data-business-id', businessId);
                
                // Change button text
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Business';
                
                // Open modal
                openAdminModal();
                
            } catch (error) {
                console.error('Error editing business:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Update business (admin)
        async function updateBusiness(businessId, event) {
        try {
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<div class="loading"></div>';
            submitBtn.disabled = true;
            
            // 1. Ekstrak data teks (bukan file) dari form
            const form = event.target;
            const formData = new FormData(form);
            const jsonData = {};
            
            // Convert form data to JSON object, excluding file inputs
            for (let [key, value] of formData.entries()) {
                // Skip file inputs
                if (key !== 'images' && key !== 'image') {
                    jsonData[key] = value;
                }
            }

            if (uploadedImages.length > 0) {
                try {
                    const base64Image = await fileToBase64(uploadedImages[0]);
                    jsonData.imageBase64 = base64Image;
                } catch (e) {
                    console.error('Error converting image to base64:', e);
                }
            }
            
            // Format data spesifik
            if (jsonData.keywords) {
                jsonData.keywords = jsonData.keywords.split(',')
                    .map(k => k.trim())
                    .filter(k => k.length > 0);
            }
            
            if (jsonData.openTime && jsonData.closeTime) {
                jsonData.businessHours = {
                    open: jsonData.openTime,
                    close: jsonData.closeTime
                };
                delete jsonData.openTime;
                delete jsonData.closeTime;
            }
            
            console.log('Sending JSON data:', jsonData);
            
            // 2. Update metadata dengan JSON
            const response = await fetch(`${API_BASE_URL}/businesses/${businessId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update business');
            }
            
            // 3. Jika ada file yang diupload, upload secara terpisah
            if (uploadedImages && uploadedImages.length > 0) {
                const imageFormData = new FormData();
                uploadedImages.forEach(file => {
                    imageFormData.append('images', file);
                });
                
                const imageResponse = await fetch(`${API_BASE_URL}/businesses/${businessId}/images`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: imageFormData
                });
                
                if (!imageResponse.ok) {
                    console.warn('Image upload failed, but business data was updated');
                }
            }
            
            // Show success message
            showToast('Business updated successfully', 'success');
            
            // Reset form and close modal
            form.reset();
            document.getElementById('imagePreview').innerHTML = '';
            uploadedImages = [];
            closeAdminModal();
            
            // Refresh data
            if (currentPage === 'listings') {
                renderListings();
            } else {
                fetchBusinesses();
            }
            
        } catch (error) {
            console.error('Error updating business:', error);
            showToast('Error: ' + error.message, 'error');
        } finally {
            // Restore button
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Business';
            submitBtn.disabled = false;
        }
    }

        // Remove existing image
        async function removeExistingImage(businessId, imageUrl) {
            try {
                // Extract image name from URL
                const imageName = imageUrl.split('/').pop();
                
                // Send request to remove image
                const response = await fetch(`${API_BASE_URL}/admin/businesses/${businessId}/images/${imageName}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to remove image');
                }
                
                // Update preview
                document.getElementById('imagePreview').innerHTML = '';
                
                showToast('Image removed successfully', 'success');
                
            } catch (error) {
                console.error('Error removing image:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Edit category (admin)
// Edit category (admin)
function editCategory(categoryId) {
    try {
        // Find category
        const category = categories.find(c => c.id === categoryId);
        if (!category) {
            throw new Error('Category not found');
        }
        
        console.log('Editing category:', category); // Debug log
        
        // Show the form container first
        const formContainer = document.getElementById('categoryFormContainer');
        formContainer.style.display = 'block';
        
        // Then populate form with current values - using setTimeout to ensure elements are accessible
        setTimeout(() => {
            const nameField = document.getElementById('categoryName');
            const iconField = document.getElementById('categoryIcon');
            const descriptionField = document.getElementById('categoryDescription');
            
            if (nameField) nameField.value = category.name || '';
            if (iconField) iconField.value = category.icon || '';
            if (descriptionField) descriptionField.value = category.description || '';
            
            console.log('Form fields populated:', {
                name: nameField?.value,
                icon: iconField?.value,
                description: descriptionField?.value
            });
            
            // Set form to edit mode
            const form = document.getElementById('addCategoryForm');
            if (form) {
                form.setAttribute('data-category-id', categoryId);
                
                // Change button text
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Category';
                }
            }
        }, 50);
        
        // Use animation to show the form (similar to showAddCategoryForm)
        formContainer.style.opacity = '0';
        formContainer.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            formContainer.style.opacity = '1';
            formContainer.style.transform = 'translateY(0)';
            // Scroll to the form
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }, 100);
        
    } catch (error) {
        console.error('Error editing category:', error);
        showToast('Error: ' + error.message, 'error');
    }
}

// Add event listener for adding/editing category
document.getElementById('addCategoryForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    try {
        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
        submitBtn.disabled = true;
        
        // Get form data
        const formData = new FormData(event.target);
        const categoryData = {
            name: formData.get('name'),
            icon: formData.get('icon'),
            description: formData.get('description')
        };
        
        // Check if we're in edit mode
        const categoryId = event.target.getAttribute('data-category-id');
        let response;
        
        if (categoryId) {
            // Edit mode
            response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(categoryData)
            });
        } else {
            // Add mode
            response = await fetch(`${API_BASE_URL}/categories`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(categoryData)
            });
        }
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to save category');
        }
        
        // Show success message
        showToast(categoryId ? 'Category updated successfully' : 'Category created successfully', 'success');
        
        // Reset form, remove edit mode attribute, and hide form
        event.target.reset();
        event.target.removeAttribute('data-category-id');
        hideAddCategoryForm();
        
        // Refresh categories
        await fetchCategories();
        loadCategoriesForAdmin();
        
    } catch (error) {
        console.error('Error saving category:', error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Restore button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
});

        // Update category (admin)
        async function updateCategory(categoryId, event) {
            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
                submitBtn.disabled = true;
                
                // Get form data
                const formData = new FormData(event.target);
                const categoryData = {
                    name: formData.get('name'),
                    icon: formData.get('icon'),
                    description: formData.get('description')
                };
                
                // Parse subcategories from textarea (one per line)
                if (formData.get('subcategories')) {
                    const subcategories = formData.get('subcategories')
                        .split('\n')
                        .map(subcat => subcat.trim())
                        .filter(subcat => subcat.length > 0);
                        
                    if (subcategories.length > 0) {
                        categoryData.subcategories = subcategories;
                    }
                }
                
                // Send request to update category
                const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categoryData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update category');
                }
                
                // Show success message
                showToast('Category updated successfully', 'success');
                
                // Reset form and hide it
                event.target.reset();
                hideAddCategoryForm();
                
                // Change button text back
                submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Category';
                
                // Refresh categories
                await fetchCategories();
                loadCategoriesForAdmin();
                populateCategoriesDropdown();
                
            } catch (error) {
                console.error('Error updating category:', error);
                showToast('Error: ' + error.message, 'error');
            } finally {
                // Restore button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Category';
                submitBtn.disabled = false;
            }
        }

        // Initialize admin functionality
        function initAdminFunctionality() {
            // Check if admin is logged in and modify the floating add button
            if (isAdminLoggedIn()) {
                document.querySelector('.floating-add').innerHTML = '<i class="fas fa-cog"></i>';
            }
        }

        // Call this in the init function
        function enhancedInit() {
    // Existing init code
    AOS.init({
        duration: 800,
        easing: 'ease-in-out',
        once: true
    });
    
    // Setup event listeners
    setupEventListeners();
    
    // Update floating add button visibility
    updateFloatingAddButton();
    
    // Fetch data and render UI
    fetchCategories().then(() => {
        renderCategories();
        return fetchBusinesses();
    }).then(() => {
        renderListings();
    }).catch(error => {
        console.error('Error initializing app:', error);
        showError('Failed to load data. Please try again later.');
    });
    
    // Initialize admin functionality
    initAdminFunctionality();
}

function updateFloatingAddButton() {
    const floatingAddButton = document.querySelector('.floating-add');
    
    if (floatingAddButton) {
        // Show button only if user is admin
        if (isLoggedInAdmin()) {
            floatingAddButton.style.display = 'flex';
            floatingAddButton.innerHTML = '<i class="fas fa-cog"></i>';
        } else {
            // Hide the button if not admin
            floatingAddButton.style.display = 'none';
        }
    }
}

        // When page loads, call our enhanced init
        document.addEventListener('DOMContentLoaded', enhancedInit);


        // Variabel untuk melacak status dropdown
        let isDropdownOpen = false;

        // Fungsi toggle dropdown
        function toggleProfileDropdown() {
            const profileDropdown = document.getElementById('profileDropdown');
            
            if (isDropdownOpen) {
                // Tutup dropdown
                profileDropdown.style.display = 'none';
                isDropdownOpen = false;
            } else {
                // Buka dropdown dan update kontennya
                profileDropdown.style.display = 'block';
                isDropdownOpen = true;
                updateDropdownContent();
            }
        }

        // Fungsi toggle dropdown
        function toggleProfileDropdown() {
            const profileDropdown = document.getElementById('profileDropdown');
            
            if (!profileDropdown) {
                console.error('Profile dropdown element not found!');
                return;
            }
            
            if (isDropdownOpen) {
                // Tutup dropdown
                profileDropdown.style.display = 'none';
                isDropdownOpen = false;
            } else {
                // Buka dropdown dan update kontennya
                profileDropdown.style.display = 'block';
                isDropdownOpen = true;
                updateDropdownContent();
            }
        }


        function updateDropdownContent() {
            const dropdownContent = document.getElementById('dropdownContent');
            
            if (isLoggedIn() || isLoggedInAdmin()) {
                // Jika user sudah login, tampilkan info user dan tombol logout
                const user = JSON.parse(localStorage.getItem('user')) || {};
                const username = user.username || 'User';
                const email = user.email || '';
                
                dropdownContent.innerHTML = `
                    <div style="padding: 15px;">
                        <button type="button" class="action-btn btn-primary" style="width: 100%;" onclick="logoutUser()">
                            <i class="fas fa-sign-in-alt"></i> Logout
                        </button>
                `;
            } else {
                // Jika user belum login, tampilkan form login
                dropdownContent.innerHTML = `
                    <div style="padding: 15px;">
                        <button type="button" class="action-btn btn-primary" style="width: 100%;" onclick="showPage('profile')">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                `;
            }
        }

        // Modifikasi fungsi logoutUser untuk menangani dropdown
        function logoutUser() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            updateUserInterface(false, false);
            showPage('home');
            closeProfileDropdown();
            updateFloatingAddButton();
            
            // Tampilkan pesan sukses
            showToast('Logged out successfully', 'success');
        }


        // Fungsi untuk menutup dropdown secara langsung
        function closeProfileDropdown() {
            document.getElementById('profileDropdown').style.display = 'none';
            isDropdownOpen = false;
        }

        // Handle login form
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorElement = document.getElementById('userLoginError');
            
            // Reset error
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            // Simple validation
            if (!username || !password) {
                if (errorElement) {
                    errorElement.textContent = 'Please enter both username and password';
                    errorElement.style.display = 'block';
                }
                return;
            }
            
            try {
                // Show loading
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
                submitBtn.disabled = true;
                
                
                // Call API to login
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Invalid credentials 3');
                }
                
                
                const data = await response.json();
                
                // Store token and user data
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                
                // Update UI for logged-in state (dipindahkan ke sini)
                updateUserInterface(true, false);
                
                // Show home page after login
                showPage('home');
                
                // Show success toast
                showToast('Login successful', 'success');
            } catch (error) {
                // Show error
                if (errorElement) {
                    errorElement.textContent = error.message || 'Login failed';
                    errorElement.style.display = 'block';
                }
                console.error('Login error:', error);
            } finally {
                // Restore button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }
        }


        // Fungsi untuk menambahkan bisnis ke favorit
async function addToFavorites(businessId, event) {
    // Hentikan event supaya tidak membuka modal bisnis
    if (event) {
        event.stopPropagation();
    }
    
    // Cek apakah user sudah login
    if (!isLoggedIn()) {
        showToast('Please login to add favorites', 'error');
        return;
    }
    
    try {
        // Kirim request untuk menambahkan favorit
        const response = await fetch(`${API_BASE_URL}/user/favorites`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ businessId })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to add favorite');
        }
        
        // Update UI
        const heartIcon = document.querySelector(`.heart-icon[data-id="${businessId}"]`);
        if (heartIcon) {
            heartIcon.classList.add('active');
            heartIcon.setAttribute('onclick', `removeFromFavorites('${businessId}', event)`);
            heartIcon.innerHTML = '<i class="fas fa-heart"></i>';
        }
        
        showToast('Added to favorites', 'success');
    } catch (error) {
        console.error('Error adding to favorites:', error);
        showToast('Error: ' + error.message, 'error');
    }
}

// Fungsi untuk menghapus bisnis dari favorit
async function removeFromFavorites(businessId, event) {
    // Hentikan event supaya tidak membuka modal bisnis
    if (event) {
        event.stopPropagation();
    }
    
    try {
        // Kirim request untuk menghapus favorit
        const response = await fetch(`${API_BASE_URL}/user/favorites/${businessId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to remove favorite');
        }
        
        // Update UI 
        const heartIcon = document.querySelector(`.heart-icon[data-id="${businessId}"]`);
        if (heartIcon) {
            heartIcon.classList.remove('active');
            heartIcon.setAttribute('onclick', `addToFavorites('${businessId}', event)`);
            heartIcon.innerHTML = '<i class="far fa-heart"></i>';
        }
        
        // Jika berada di halaman favorit, refresh halaman
        if (currentPage === 'favorites') {
            fetchUserFavorites();
        }
        
        showToast('Removed from favorites', 'success');
    } catch (error) {
        console.error('Error removing from favorites:', error);
        showToast('Error: ' + error.message, 'error');
    }
}

// Fungsi untuk mengecek apakah bisnis sudah difavoritkan
async function checkFavoriteStatus(businessIds) {
    if (!isLoggedIn() || !businessIds || businessIds.length === 0) {
        return {};
    }
    
    try {
        // Dapatkan semua favorit pengguna
        const response = await fetch(`${API_BASE_URL}/user/favorites`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch favorites');
        }
        
        const favorites = await response.json();
        
        // Buat map untuk menyimpan status favorit
        const favoriteStatus = {};
        favorites.forEach(fav => {
            favoriteStatus[fav.id] = true;
        });
        
        return favoriteStatus;
    } catch (error) {
        console.error('Error checking favorite status:', error);
        return {};
    }
}
// Variables for subcategory pagination
let allSubcategories = [];
let filteredSubcategories = [];
let subcategoryCurrentPage = 1;
let subcategoryItemsPerPage = 10;

// Function to load all subcategories
async function loadAllSubcategories() {
    try {
        console.log('Loading all subcategories...');
        
        // Show loading state
        document.getElementById('adminSubcategoryList').innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px;">
                    <div class="loading" style="display: inline-block;"></div>
                    <p style="margin-top: 10px;">Loading subcategories...</p>
                </td>
            </tr>
        `;
        
        // Fetch all subcategories
        const response = await fetch(`${API_BASE_URL}/categories/subcategories/all`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch subcategories: ${response.status}`);
        }
        
        const data = await response.json();
        allSubcategories = Array.isArray(data) ? data : (data.data || []);
        
        // Initialize filtered subcategories
        filteredSubcategories = [...allSubcategories];
        
        // Update UI
        filterSubcategories();
        
        // Load categories for filter dropdown
        loadCategoriesForDropdowns();
        
    } catch (error) {
        console.error('Error loading subcategories:', error);
        document.getElementById('adminSubcategoryList').innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px; color: var(--danger);">
                    <i class="fas fa-exclamation-circle"></i>
                    Error loading subcategories: ${error.message}
                    <button class="action-btn btn-primary" style="margin-top: 10px;" onclick="loadAllSubcategories()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </td>
            </tr>
        `;
    }
}

// Function to load categories for dropdowns
function loadCategoriesForDropdowns() {
    // Populate filter dropdown
    const filterSelect = document.getElementById('filterCategory');
    const addFormSelect = document.getElementById('subcategoryCategory');
    const editFormSelect = document.getElementById('editSubcategoryCategory');
    
    // Clear options except first one
    filterSelect.innerHTML = '<option value="">All Categories</option>';
    addFormSelect.innerHTML = '<option value="">Select a category</option>';
    editFormSelect.innerHTML = '<option value="">Select a category</option>';
    
    // Add options for each category
    categories.forEach(category => {
        const filterOption = document.createElement('option');
        filterOption.value = category.id;
        filterOption.textContent = category.name;
        filterSelect.appendChild(filterOption);
        
        const addFormOption = document.createElement('option');
        addFormOption.value = category.id;
        addFormOption.textContent = category.name;
        addFormSelect.appendChild(addFormOption);
        
        const editFormOption = document.createElement('option');
        editFormOption.value = category.id;
        editFormOption.textContent = category.name;
        editFormSelect.appendChild(editFormOption);
    });
}

// Function to filter subcategories
function filterSubcategories() {
    const categoryFilter = document.getElementById('filterCategory').value;
    const searchQuery = document.getElementById('searchSubcategory').value.toLowerCase();
    
    // Apply filters
    filteredSubcategories = allSubcategories.filter(subcategory => {
        // Category filter
        if (categoryFilter && subcategory.categoryId !== categoryFilter) {
            return false;
        }
        
        // Search query
        if (searchQuery) {
            return subcategory.name.toLowerCase().includes(searchQuery) || 
                   (subcategory.slug && subcategory.slug.toLowerCase().includes(searchQuery));
        }
        
        return true;
    });
    
    // Reset pagination
    subcategoryCurrentPage = 1;
    
    // Update UI
    renderSubcategoriesPage();
}

// Function to render subcategories page
function renderSubcategoriesPage() {
    // Calculate page info
    const totalPages = Math.ceil(filteredSubcategories.length / subcategoryItemsPerPage);
    const startIndex = (subcategoryCurrentPage - 1) * subcategoryItemsPerPage;
    const endIndex = Math.min(startIndex + subcategoryItemsPerPage, filteredSubcategories.length);
    const subcategoriesToShow = filteredSubcategories.slice(startIndex, endIndex);
    
     // Update page info text
     document.getElementById('subcategoryPageInfo').textContent = 
        `Page ${subcategoryCurrentPage} of ${totalPages || 1} (${filteredSubcategories.length} total)`;
    
    // Update pagination buttons
    document.getElementById('subcategoryPrevPageBtn').disabled = subcategoryCurrentPage <= 1;
    document.getElementById('subcategoryNextPageBtn').disabled = subcategoryCurrentPage >= totalPages;
    
    // Get subcategory list container
    const adminSubcategoryList = document.getElementById('adminSubcategoryList');
    
    // Check if no subcategories found
    if (subcategoriesToShow.length === 0) {
        adminSubcategoryList.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px;">
                    No subcategories found. ${
                        document.getElementById('filterCategory').value || document.getElementById('searchSubcategory').value 
                        ? 'Try changing your filters.' 
                        : 'Click "Add Subcategory" to create one.'
                    }
                </td>
            </tr>
        `;
        return;
    }
    
    // Render subcategories
    adminSubcategoryList.innerHTML = subcategoriesToShow.map(subcategory => {
        // Find parent category
        const parentCategory = categories.find(c => c.id === subcategory.categoryId);
        const categoryName = parentCategory ? parentCategory.name : 'Unknown Category';
        
        return `
            <tr data-subcategory-id="${subcategory.id}">
                <td>${subcategory.name}</td>
                <td>${subcategory.slug || '-'}</td>
                <td>${categoryName}</td>
                <td>
                    <button class="admin-action-btn btn-edit" onclick="editSubcategory('${subcategory.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="admin-action-btn btn-delete" onclick="confirmDeleteSubcategory('${subcategory.id}')">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Function to change page
function changeSubcategoryPage(direction) {
    subcategoryCurrentPage += direction;
    renderSubcategoriesPage();
}

// Force CSS untuk memastikan form subcategory muncul
const forceFormCSS = document.createElement('style');
forceFormCSS.textContent = `
  #addSubcategoryFormContainer.force-show {
    display: block !important;
    position: relative !important;
    z-index: 1000 !important;
    opacity: 1 !important;
    visibility: visible !important;
    background-color: white !important;
    padding: 20px !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1) !important;
    margin-top: 15px !important;
    border: 1px solid #ddd !important;
  }
  
  #subcategoryListContainer.force-hide {
    display: none !important;
  }
`;
document.head.appendChild(forceFormCSS);

// Fungsi alternatif untuk memastikan form muncul
function forceShowSubcategoryForm() {
    console.log('Force showing subcategory form');
    
    // Cari form container
    const addSubcategoryFormContainer = document.getElementById('addSubcategoryFormContainer');
    const subcategoryListContainer = document.getElementById('subcategoryListContainer');
    
    if (!addSubcategoryFormContainer) {
        console.error('Form container not found, creating new one');
        
        // Jika tidak ditemukan, cari parent container
        const parentContainer = document.getElementById('manage-subcategories-content');
        if (!parentContainer) {
            console.error('Parent container not found');
            showToast('Error: Cannot show form', 'error');
            return;
        }
        
        // Buat container baru
        const newFormContainer = document.createElement('div');
        newFormContainer.id = 'addSubcategoryFormContainer';
        newFormContainer.className = 'force-show';
        newFormContainer.innerHTML = `
            <div class="admin-section-header">
                <h2>Add New Subcategory</h2>
            </div>
            
            <form id="addSubcategoryForm" class="admin-form">
                <div class="form-row">
                    <label for="subcategoryName">Subcategory Name *</label>
                    <input type="text" id="subcategoryName" name="name" required placeholder="Enter subcategory name">
                </div>
                
                <div class="form-row">
                    <label for="subcategorySlug">Slug (URL Friendly)</label>
                    <input type="text" id="subcategorySlug" name="slug" maxlength="100" 
                           placeholder="Will be generated automatically if empty">
                    <small class="form-hint">Used in URLs, maximum 100 characters, lowercase letters, numbers and hyphens only</small>
                </div>
                
                <div class="form-row">
                    <label for="subcategoryDescription">Description</label>
                    <textarea id="subcategoryDescription" name="description" rows="3" placeholder="Describe the subcategory"></textarea>
                </div>
                
                <div class="form-row">
                    <label for="subcategoryCategory">Parent Category *</label>
                    <select id="subcategoryCategory" name="categoryId" required>
                        <option value="">Select a category</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="action-btn btn-secondary" onclick="hideAddSubcategoryForm()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="action-btn btn-primary">
                        <i class="fas fa-plus-circle"></i> Add Subcategory
                    </button>
                </div>
            </form>
        `;
        
        // Tambahkan ke DOM
        parentContainer.prepend(newFormContainer);
        
        // Atur event listener
        const form = document.getElementById('addSubcategoryForm');
        if (form) {
            form.addEventListener('submit', handleAddSubcategoryForm);
        }
        
        // Populasi dropdown
        loadCategoriesForDropdowns();
        
    } else {
        // Reset form
        const form = document.getElementById('addSubcategoryForm');
        if (form) form.reset();
        
        // Sembunyikan list container
        if (subcategoryListContainer) {
            subcategoryListContainer.style.display = 'none';
            subcategoryListContainer.classList.add('force-hide');
        }
        
        // Tampilkan form container dengan gaya yang dipaksakan
        addSubcategoryFormContainer.style.cssText = `
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 1000 !important;
        `;
        addSubcategoryFormContainer.classList.add('force-show');
    }
    
    // Populasi dropdown kategori
    loadCategoriesForDropdowns();
    
    // Scroll ke form
    setTimeout(() => {
        const formContainer = document.getElementById('addSubcategoryFormContainer');
        if (formContainer) formContainer.scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

// Modify the show and hide functions to use force classes
function showAddSubcategoryForm() {
    console.log('Attempting to show add subcategory form');
    
    // Dapatkan referensi ke container
    const addSubcategoryFormContainer = document.getElementById('addSubcategoryFormContainer');
    const subcategoryListContainer = document.getElementById('subcategoryListContainer');
    
    // Debug - cek apakah element ditemukan
    console.log('Form container found:', !!addSubcategoryFormContainer);
    console.log('List container found:', !!subcategoryListContainer);
    
    if (!addSubcategoryFormContainer) {
        console.error('addSubcategoryFormContainer element not found!');
        showToast('Error: Form container not found', 'error');
        return;
    }
    
    // Reset form jika ada
    const form = document.getElementById('addSubcategoryForm');
    if (form) {
        form.reset();
    }
    
    // Sembunyikan container list jika ada
    if (subcategoryListContainer) {
        subcategoryListContainer.style.display = 'none';
    }
    
    // PERBAIKAN: Tambahkan class force-show untuk memastikan form muncul
    addSubcategoryFormContainer.classList.add('force-show');
    
    // Tampilkan form dengan animasi seperti category, tapi gunakan !important
    addSubcategoryFormContainer.style.cssText = `
        opacity: 0;
        transform: translateY(-20px);
        display: block !important;
        visibility: visible !important;
        z-index: 1000 !important;
    `;
    
    // Tambahkan delay yang lebih lama
    setTimeout(() => {
        addSubcategoryFormContainer.style.cssText = `
            opacity: 1 !important;
            transform: translateY(0) !important;
            display: block !important;
            visibility: visible !important;
            z-index: 1000 !important;
        `;
        console.log('Add subcategory form should now be visible');
        
        // Scroll ke form
        addSubcategoryFormContainer.scrollIntoView({ behavior: 'smooth' });
    }, 50); // Tambahkan delay yang lebih lama
}

// Perbaikan fungsi hideAddSubcategoryForm
function hideAddSubcategoryForm() {
    console.log('Hiding add subcategory form');
    
    const addSubcategoryFormContainer = document.getElementById('addSubcategoryFormContainer');
    const subcategoryListContainer = document.getElementById('subcategoryListContainer');
    
    if (!addSubcategoryFormContainer) {
        console.error('addSubcategoryFormContainer element not found!');
        return;
    }
    
    // Sembunyikan dengan animasi
    addSubcategoryFormContainer.style.opacity = '0';
    addSubcategoryFormContainer.style.transform = 'translateY(-20px)';
    
    setTimeout(() => {
        addSubcategoryFormContainer.style.display = 'none';
        
        // Reset form
        const form = document.getElementById('addSubcategoryForm');
        if (form) {
            form.reset();
        }
        
        // Tampilkan kembali container list
        if (subcategoryListContainer) {
            subcategoryListContainer.style.display = 'block';
        }
    }, 300);
}

// Event handler for add subcategory form
async function handleAddSubcategoryForm(event) {
    event.preventDefault();
    
    try {
        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
        submitBtn.disabled = true;
        
        // Get form data
        const formData = new FormData(event.target);
        const subcategoryData = {
            name: formData.get('name'),
            slug: formData.get('slug') || '',
            description: formData.get('description') || '',
            categoryId: formData.get('categoryId')
        };
        
        // Validate
        if (!subcategoryData.name) {
            throw new Error('Subcategory name is required');
        }
        
        if (!subcategoryData.categoryId) {
            throw new Error('Parent category is required');
        }
        
        // Generate slug if empty
        if (!subcategoryData.slug && subcategoryData.name) {
            subcategoryData.slug = subcategoryData.name
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 100);
        }
        
        // Send request
        const response = await fetch(`${API_BASE_URL}/categories/subcategories`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(subcategoryData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to create subcategory');
        }
        
        // Show success message
        showToast('Subcategory created successfully', 'success');
        
        // Reset form and hide
        event.target.reset();
        hideAddSubcategoryForm();
        
        // Reload subcategories
        await loadAllSubcategories();
        
    } catch (error) {
        console.error('Error creating subcategory:', error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Restore button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
}

// Function to hide edit subcategory form
function hideEditSubcategoryForm() {
    // Hide edit form, show list
    document.getElementById('editSubcategoryFormContainer').style.display = 'none';
    document.getElementById('subcategoryListContainer').style.display = 'block';
}

// Event handler for edit subcategory form
async function handleEditSubcategoryForm(event) {
    event.preventDefault();
    
    try {
        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
        submitBtn.disabled = true;
        
        // Get form data
        const formData = new FormData(event.target);
        const subcategoryId = formData.get('id');
        
        const subcategoryData = {
            name: formData.get('name'),
            slug: formData.get('slug') || '',
            description: formData.get('description') || '',
            categoryId: formData.get('categoryId')
        };
        
        // Validate
        if (!subcategoryData.name) {
            throw new Error('Subcategory name is required');
        }
        
        if (!subcategoryData.categoryId) {
            throw new Error('Parent category is required');
        }
        
        // Generate slug if empty
        if (!subcategoryData.slug && subcategoryData.name) {
            subcategoryData.slug = subcategoryData.name
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 100);
        }
        
        // Send request
        const response = await fetch(`${API_BASE_URL}/categories/subcategories/${subcategoryId}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(subcategoryData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to update subcategory');
        }
        
        // Show success message
        showToast('Subcategory updated successfully', 'success');
        
        // Hide form
        hideEditSubcategoryForm();
        
        // Reload subcategories
        await loadAllSubcategories();
        
    } catch (error) {
        console.error('Error updating subcategory:', error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Restore button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
}

// Function to confirm delete subcategory
function confirmDeleteSubcategory(subcategoryId) {
    // Find subcategory
    const subcategory = allSubcategories.find(s => s.id === subcategoryId);
    if (!subcategory) {
        showToast('Subcategory not found', 'error');
        return;
    }
    
    // Find category
    const category = categories.find(c => c.id === subcategory.categoryId);
    const categoryName = category ? category.name : 'Unknown Category';
    
    if (!confirm(`Are you sure you want to delete the subcategory "${subcategory.name}"?\nThis subcategory belongs to category: ${categoryName}`)) {
        return;
    }
    
    deleteSubcategory(subcategoryId);
}

// Function to delete subcategory
async function deleteSubcategory(subcategoryId) {
    try {
        // Show loading
        showToast('Deleting subcategory...', 'info');
        
        // Send delete request
        const response = await fetch(`${API_BASE_URL}/categories/subcategories/${subcategoryId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to delete subcategory');
        }
        
        // Show success message
        showToast('Subcategory deleted successfully', 'success');
        
        // Reload subcategories
        await loadAllSubcategories();
        
    } catch (error) {
        console.error('Error deleting subcategory:', error);
        showToast('Error: ' + error.message, 'error');
    }
}

function initSubcategoriesTab() {
    console.log('Initializing subcategories tab...');
    
    // Add event listeners
    const addSubcategoryForm = document.getElementById('addSubcategoryForm');
    if (addSubcategoryForm) {
        addSubcategoryForm.addEventListener('submit', handleAddSubcategoryForm);
        console.log('Add subcategory form event listener attached');
    } else {
        console.error('Add subcategory form not found!');
    }
    
    const editSubcategoryForm = document.getElementById('editSubcategoryForm');
    if (editSubcategoryForm) {
        editSubcategoryForm.addEventListener('submit', handleEditSubcategoryForm);
        console.log('Edit subcategory form event listener attached');
    } else {
        console.error('Edit subcategory form not found!');
    }
    
    const searchSubcategory = document.getElementById('searchSubcategory');
    if (searchSubcategory) {
        searchSubcategory.addEventListener('input', filterSubcategories);
        console.log('Search subcategory input event listener attached');
    } else {
        console.error('Search subcategory input not found!');
    }
    
    // Fix page change function calls
    const prevPageBtn = document.getElementById('subcategoryPrevPageBtn');
    const nextPageBtn = document.getElementById('subcategoryNextPageBtn');
    
    if (prevPageBtn && nextPageBtn) {
        prevPageBtn.onclick = () => changeSubcategoryPage(-1);
        nextPageBtn.onclick = () => changeSubcategoryPage(1);
        console.log('Pagination button event listeners attached');
    } else {
        console.error('Pagination buttons not found!', {
            prevButton: !!prevPageBtn,
            nextButton: !!nextPageBtn
        });
    }
    
    // Load subcategories
    console.log('Loading all subcategories...');
    loadAllSubcategories();
}

// Pastikan tab subcategories ditambahkan ke admin tabs
function updateAdminTabs() {
    const adminTabs = document.querySelector('.admin-tabs');
    
    // Periksa apakah tab subcategories sudah ada
    const existingSubcategoriesTab = Array.from(adminTabs.children).find(
        tab => tab.getAttribute('data-tab') === 'manage-subcategories'
    );
    
    // Jika belum ada, tambahkan
    if (!existingSubcategoriesTab) {
        const subcategoriesTab = document.createElement('div');
        subcategoriesTab.className = 'admin-tab';
        subcategoriesTab.setAttribute('data-tab', 'manage-subcategories');
        subcategoriesTab.textContent = 'Subcategories';
        
        adminTabs.appendChild(subcategoriesTab);
        
        console.log('Subcategories tab added to admin panel');
    }
}

// Fungsi untuk memastikan form subcategory muncul dengan membuatnya langsung di DOM
function createSubcategoryForm() {
    console.log('Creating subcategory form directly in DOM');
    
    // Cari parent container
    const parentContainer = document.getElementById('manage-subcategories-content');
    if (!parentContainer) {
        console.error('Parent container not found');
        showToast('Error: Cannot create form', 'error');
        return;
    }
    
    // Sembunyikan container list jika ada
    const subcategoryListContainer = document.getElementById('subcategoryListContainer');
    if (subcategoryListContainer) {
        subcategoryListContainer.style.display = 'none';
    }
    
    // Hapus form lama jika ada
    const existingForm = document.getElementById('dynamic-subcategory-form-container');
    if (existingForm) {
        existingForm.remove();
    }
    
    // Buat container baru
    const formContainer = document.createElement('div');
    formContainer.id = 'dynamic-subcategory-form-container';
    formContainer.style.backgroundColor = 'white';
    formContainer.style.padding = '25px';
    formContainer.style.borderRadius = '12px';
    formContainer.style.boxShadow = '0 4px 20px rgba(0,0,0,0.08)';
    formContainer.style.marginTop = '20px';
    
    // Set HTML content untuk form
    formContainer.innerHTML = `
        <div class="admin-section-header">
            <h2 style="font-size: 24px; margin: 0; padding-bottom: 15px; border-bottom: 2px solid var(--primary); color: var(--primary);">
                Add New Subcategory
            </h2>
        </div>
        
        <form id="dynamic-subcategory-form" class="admin-form">
            <div class="form-row">
                <label for="dynamicSubcategoryName">Subcategory Name *</label>
                <input type="text" id="dynamicSubcategoryName" name="name" required placeholder="Enter subcategory name">
            </div>
            
            <div class="form-row">
                <label for="dynamicSubcategorySlug">Slug (URL Friendly)</label>
                <input type="text" id="dynamicSubcategorySlug" name="slug" maxlength="100" 
                       placeholder="Will be generated automatically if empty">
                <small class="form-hint">Used in URLs, maximum 100 characters, lowercase letters, numbers and hyphens only</small>
            </div>
            
            <div class="form-row">
                <label for="dynamicSubcategoryDescription">Description</label>
                <textarea id="dynamicSubcategoryDescription" name="description" rows="3" placeholder="Describe the subcategory"></textarea>
            </div>
            
            <div class="form-row">
                <label for="dynamicSubcategoryCategory">Parent Category *</label>
                <select id="dynamicSubcategoryCategory" name="categoryId" required>
                    <option value="">Select a category</option>
                    ${categories.map(category => `
                        <option value="${category.id}">${category.name}</option>
                    `).join('')}
                </select>
            </div>
            
            <div class="form-actions">
                <button type="button" class="action-btn btn-secondary" onclick="hideSubcategoryForm()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="action-btn btn-primary">
                    <i class="fas fa-plus-circle"></i> Add Subcategory
                </button>
            </div>
        </form>
    `;
    
    // Tambahkan ke DOM di awal parent container
    parentContainer.insertBefore(formContainer, parentContainer.firstChild);
    
    // Tambahkan event listener untuk form
    document.getElementById('dynamic-subcategory-form').addEventListener('submit', handleDynamicSubcategoryForm);
    
    // Scroll ke form
    formContainer.scrollIntoView({ behavior: 'smooth' });
    
    console.log('Subcategory form created and added to DOM');
}

// Fungsi untuk menangani submit form
async function handleDynamicSubcategoryForm(event) {
    event.preventDefault();
    
    try {
        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
        submitBtn.disabled = true;
        
        // Get form data
        const formData = new FormData(event.target);
        const subcategoryData = {
            name: formData.get('name'),
            slug: formData.get('slug') || '',
            description: formData.get('description') || '',
            categoryId: formData.get('categoryId')
        };
        
        console.log('Submitting subcategory data:', subcategoryData);
        
        // Validate
        if (!subcategoryData.name) {
            throw new Error('Subcategory name is required');
        }
        
        if (!subcategoryData.categoryId) {
            throw new Error('Parent category is required');
        }
        
        // Generate slug if empty
        if (!subcategoryData.slug && subcategoryData.name) {
            subcategoryData.slug = subcategoryData.name
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 100);
        }
        
        // Send request
        const response = await fetch(`${API_BASE_URL}/categories/subcategories`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(subcategoryData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to create subcategory');
        }
        
        // Show success message
        showToast('Subcategory created successfully', 'success');
        
        // Reset form and hide
        event.target.reset();
        hideSubcategoryForm();
        
        // Reload subcategories
        await loadAllSubcategories();
        
    } catch (error) {
        console.error('Error creating subcategory:', error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Restore button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
}

// Fungsi untuk menyembunyikan form
function hideSubcategoryForm() {
    const formContainer = document.getElementById('dynamic-subcategory-form-container');
    if (formContainer) {
        formContainer.style.display = 'none';
    }
    
    const subcategoryListContainer = document.getElementById('subcategoryListContainer');
    if (subcategoryListContainer) {
        subcategoryListContainer.style.display = 'block';
    }
}

// Update onclick handler untuk tombol Add Subcategory
document.querySelector('.admin-section-header button').onclick = createSubcategoryForm;


// Fungsi untuk mengedit subcategory dengan membuat form langsung di DOM
function createEditSubcategoryForm(subcategoryId) {
    console.log('Creating edit subcategory form directly in DOM', subcategoryId);
    
    // Cari parent container
    const parentContainer = document.getElementById('manage-subcategories-content');
    if (!parentContainer) {
        console.error('Parent container not found');
        showToast('Error: Cannot create edit form', 'error');
        return;
    }
    
    // Cari subcategory yang akan diedit
    const subcategory = allSubcategories.find(s => s.id === subcategoryId);
    if (!subcategory) {
        console.error('Subcategory not found:', subcategoryId);
        showToast('Error: Subcategory not found', 'error');
        return;
    }
    
    // Cari parent category
    const parentCategory = categories.find(c => c.id === subcategory.categoryId);
    
    // Sembunyikan container list jika ada
    const subcategoryListContainer = document.getElementById('subcategoryListContainer');
    if (subcategoryListContainer) {
        subcategoryListContainer.style.display = 'none';
    }
    
    // Hapus form lama jika ada
    const existingForm = document.getElementById('dynamic-subcategory-edit-form-container');
    if (existingForm) {
        existingForm.remove();
    }
    
    // Buat container baru
    const formContainer = document.createElement('div');
    formContainer.id = 'dynamic-subcategory-edit-form-container';
    formContainer.style.backgroundColor = 'white';
    formContainer.style.padding = '25px';
    formContainer.style.borderRadius = '12px';
    formContainer.style.boxShadow = '0 4px 20px rgba(0,0,0,0.08)';
    formContainer.style.marginTop = '20px';
    
    // Set HTML content untuk form
    formContainer.innerHTML = `
        <div class="admin-section-header">
            <h2 style="font-size: 24px; margin: 0; padding-bottom: 15px; border-bottom: 2px solid var(--secondary); color: var(--secondary);">
                Edit Subcategory
            </h2>
        </div>
        
        <form id="dynamic-subcategory-edit-form" class="admin-form">
            <input type="hidden" name="id" value="${subcategory.id}">
            
            <div class="form-row">
                <label for="dynamicEditSubcategoryName">Subcategory Name *</label>
                <input type="text" id="dynamicEditSubcategoryName" name="name" required 
                       placeholder="Enter subcategory name" value="${subcategory.name || ''}">
            </div>
            
            <div class="form-row">
                <label for="dynamicEditSubcategorySlug">Slug (URL Friendly)</label>
                <input type="text" id="dynamicEditSubcategorySlug" name="slug" maxlength="100" 
                       placeholder="Will be generated automatically if empty" value="${subcategory.slug || ''}">
                <small class="form-hint">Used in URLs, maximum 100 characters, lowercase letters, numbers and hyphens only</small>
            </div>
            
            <div class="form-row">
                <label for="dynamicEditSubcategoryDescription">Description</label>
                <textarea id="dynamicEditSubcategoryDescription" name="description" rows="3" 
                         placeholder="Describe the subcategory">${subcategory.description || ''}</textarea>
            </div>
            
            <div class="form-row">
                <label for="dynamicEditSubcategoryCategory">Parent Category *</label>
                <select id="dynamicEditSubcategoryCategory" name="categoryId" required>
                    <option value="">Select a category</option>
                    ${categories.map(category => `
                        <option value="${category.id}" ${category.id === subcategory.categoryId ? 'selected' : ''}>
                            ${category.name}
                        </option>
                    `).join('')}
                </select>
            </div>
            
            <div class="form-actions">
                <button type="button" class="action-btn btn-secondary" onclick="hideEditSubcategoryForm()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="action-btn btn-primary">
                    <i class="fas fa-save"></i> Update Subcategory
                </button>
            </div>
        </form>
    `;
    
    // Tambahkan ke DOM di awal parent container
    parentContainer.insertBefore(formContainer, parentContainer.firstChild);
    
    // Tambahkan event listener untuk form
    document.getElementById('dynamic-subcategory-edit-form').addEventListener('submit', handleDynamicEditSubcategoryForm);
    
    // Scroll ke form
    formContainer.scrollIntoView({ behavior: 'smooth' });
    
    console.log('Edit subcategory form created and added to DOM');
}

// Fungsi untuk menyembunyikan form edit
function hideEditSubcategoryForm() {
    const formContainer = document.getElementById('dynamic-subcategory-edit-form-container');
    if (formContainer) {
        formContainer.style.display = 'none';
    }
    
    const subcategoryListContainer = document.getElementById('subcategoryListContainer');
    if (subcategoryListContainer) {
        subcategoryListContainer.style.display = 'block';
    }
}

// Fungsi untuk menangani submit form edit
async function handleDynamicEditSubcategoryForm(event) {
    event.preventDefault();
    
    try {
        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
        submitBtn.disabled = true;
        
        // Get form data
        const formData = new FormData(event.target);
        const subcategoryId = formData.get('id');
        
        const subcategoryData = {
            name: formData.get('name'),
            slug: formData.get('slug') || '',
            description: formData.get('description') || '',
            categoryId: formData.get('categoryId')
        };
        
        console.log('Updating subcategory data:', subcategoryId, subcategoryData);
        
        // Validate
        if (!subcategoryData.name) {
            throw new Error('Subcategory name is required');
        }
        
        if (!subcategoryData.categoryId) {
            throw new Error('Parent category is required');
        }
        
        // Generate slug if empty
        if (!subcategoryData.slug && subcategoryData.name) {
            subcategoryData.slug = subcategoryData.name
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 100);
        }
        
        // Send request
        const response = await fetch(`${API_BASE_URL}/categories/subcategories/${subcategoryId}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(subcategoryData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to update subcategory');
        }
        
        // Show success message
        showToast('Subcategory updated successfully', 'success');
        
        // Hide form
        hideEditSubcategoryForm();
        
        // Reload subcategories
        await loadAllSubcategories();
        
    } catch (error) {
        console.error('Error updating subcategory:', error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Restore button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
}

// Ganti fungsi editSubcategory yang lama
function editSubcategory(subcategoryId) {
    createEditSubcategoryForm(subcategoryId);
}

// Fix to ensure table headers are visible
function fixTableHeaders() {
    const tableHeads = document.querySelectorAll('.admin-table thead');
    tableHeads.forEach(thead => {
        thead.style.display = 'table-header-group';
        
        const headers = thead.querySelectorAll('th');
        headers.forEach(th => {
            th.style.display = 'table-cell';
            th.style.visibility = 'visible';
            th.style.color = 'white';
            th.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%)';
            th.style.padding = '15px';
            th.style.fontWeight = '600';
        });
    });
}

// Call the fix after tables are loaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(fixTableHeaders, 500);
    
    // Also fix headers when switching tabs
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            setTimeout(fixTableHeaders, 300);
        });
    });
});

// Function to show registration form
function showRegisterForm() {
    // Get the profile page content area
    const profileContent = document.getElementById('profilePage').querySelector('div[style="padding: 20px;"]');
    
    if (!profileContent) {
        console.error('Profile content area not found');
        return;
    }
    
    // Replace content with registration form
    profileContent.innerHTML = `
        <div class="login-tabs">
            <div class="login-tab" id="loginTab" onclick="showLoginForm()">Login</div>
            <div class="login-tab active" id="registerTab">Register</div>
        </div>
        
        <div id="registerForm" class="login-form active">
            <form onsubmit="handleRegister(event)">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Username</label>
                    <input type="text" id="registerUsername" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email</label>
                    <input type="email" id="registerEmail" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Password</label>
                    <input type="password" id="registerPassword" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Confirm Password</label>
                    <input type="password" id="confirmPassword" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                </div>
                <button type="submit" class="action-btn btn-primary" style="width: 100%;">
                    <i class="fas fa-user-plus"></i> Register
                </button>
                <p style="text-align: center; margin-top: 15px; color: var(--text-secondary);">
                    Already have an account? <a href="#" onclick="showLoginForm()" style="color: var(--primary);">Login</a>
                </p>
                <div id="registerError" style="color: var(--danger); margin-top: 15px; text-align: center; display: none;"></div>
            </form>
        </div>
    `;
}

// Function to show login form (go back from registration)
function showLoginForm() {
    // Switch back to the login form
    const profilePage = document.getElementById('profilePage');
    
    profilePage.innerHTML = `
        <div class="listings-header">
            <h2 class="listings-title">Your Profile</h2>
            <p class="listings-subtitle">Login to your account</p>
        </div>
        <div style="padding: 20px;">
            <div class="login-tabs">
                <div class="login-tab active" id="userLoginTab" onclick="switchLoginTab('user')">User Login</div>
                <div class="login-tab" id="adminLoginTab" onclick="switchLoginTab('admin')">Admin Login</div>
            </div>
            
            <div id="userLoginForm" class="login-form active">
                <form onsubmit="handleLogin(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Username</label>
                        <input type="text" id="adminUsername" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Password</label>
                        <input type="password" id="adminPassword" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                    </div>
                    <button type="submit" class="action-btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <p style="text-align: center; margin-top: 15px; color: var(--text-secondary);">
                        Don't have an account? <a href="#" onclick="showRegisterForm()" style="color: var(--primary);">Register</a>
                    </p>
                    <div id="userLoginError" style="color: var(--danger); margin-top: 15px; text-align: center; display: none;"></div>
                </form>
            </div>
            
            <div id="adminLoginForm" class="login-form">
                <form onsubmit="handleAdminLogin(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Admin Username</label>
                        <input type="text" id="adminUsername2" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Admin Password</label>
                        <input type="password" id="adminPassword2" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                    </div>
                    <button type="submit" class="action-btn btn-primary" style="width: 100%; background-color: #8b5cf6;">
                        <i class="fas fa-lock"></i> Login as Admin
                    </button>
                    <div id="adminLoginError2" style="color: var(--danger); margin-top: 15px; text-align: center; display: none;"></div>
                </form>
            </div>
        </div>
    `;
}

// Handle registration form submission
async function handleRegister(event) {
    event.preventDefault();
    
    const username = document.getElementById('registerUsername').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const errorElement = document.getElementById('registerError');
    
    // Reset error
    errorElement.style.display = 'none';
    
    // Simple validation
    if (!username || !email || !password || !confirmPassword) {
        errorElement.textContent = 'Please fill in all fields';
        errorElement.style.display = 'block';
        return;
    }
    
    // Check if passwords match
    if (password !== confirmPassword) {
        errorElement.textContent = 'Passwords do not match';
        errorElement.style.display = 'block';
        return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        errorElement.textContent = 'Please enter a valid email address';
        errorElement.style.display = 'block';
        return;
    }
    
    try {
        // Show loading
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading" style="width: 20px; height: 20px;"></div>';
        submitBtn.disabled = true;
        
        // Send registration request
        const response = await fetch(`${API_BASE_URL}/auth/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username,
                email,
                password
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Registration failed');
        }
        
        const data = await response.json();
        
        // Auto-login after successful registration
        localStorage.setItem('token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));
        
        // Update UI for logged-in state
        updateUserInterface(true, false);
        
        // Show success toast and redirect to home
        showToast('Registration successful! Welcome to PAW Directory', 'success');
        showPage('home');
        
    } catch (error) {
        // Show error
        errorElement.textContent = error.message || 'Registration failed';
        errorElement.style.display = 'block';
        console.error('Registration error:', error);
    } finally {
        // Restore button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Register';
        submitBtn.disabled = false;
    }
}



        


                // Initialize app when page loads
                document.addEventListener('DOMContentLoaded', init);
            </script>
            // ...existing code...
        </body>
        </html>iat